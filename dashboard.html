<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberLabel - Command Center</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --gold-dim: rgba(212, 175, 55, 0.1);
            --bg: #0a0a0a;
            --panel: #141414;
            --border: #222;
            --text: #e0e0e0;
            --text-muted: #888;
            --success: #2ecc71;
            --danger: #e74c3c;
            --input-bg: #1f1f1f;
        }

        /* SCROLL INVISÍVEL */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* MODAL GERAL E CONFIRMAÇÃO */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); animation: fadeIn 0.3s ease-out; }
        .modal-box, .confirm-box { background: rgba(30, 30, 30, 0.95); border: 1px solid var(--gold); border-radius: 16px; padding: 30px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: scale(0.95); animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; position: relative; }
        @keyframes scaleUp { to { transform: scale(1); } }
        
        .confirm-icon { font-size: 3.5rem; color: var(--gold); margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.3)); }
        .modal-title, .confirm-title { font-family: 'Playfair Display', serif; font-size: 1.6rem; color: #fff; margin-bottom: 10px; }
        .confirm-text { color: #ccc; font-size: 0.95rem; margin-bottom: 25px; line-height: 1.5; }
        
        .modal-input { width: 100%; padding: 12px; margin-bottom: 12px; background: #252525; border: 1px solid #444; color: white; border-radius: 8px; outline: none; transition: 0.3s; }
        .modal-input:focus { border-color: var(--gold); background: #2a2a2a; }
        
        .modal-actions, .confirm-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-modal { padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: 0.3s; flex: 1; font-size: 0.9rem; }
        .btn-modal-cancel { background: transparent; border: 1px solid #444; color: #aaa; }
        .btn-modal-cancel:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #666; }
        .btn-modal-confirm { background: var(--gold); color: #000; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2); }
        .btn-modal-confirm:hover { background: #eec956; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3); }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { background: var(--panel); border: 1px solid var(--border); padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; }
        .login-box h2 { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--border); color: white; border-radius: 6px; outline: none; }
        .pass-wrapper { position: relative; margin-bottom: 15px; }
        .pass-wrapper input { margin-bottom: 0; padding-right: 40px; }
        .pass-eye { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted); }
        .login-box button { width: 100%; padding: 12px; background: var(--gold); border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 15px; }
        .app-content { display: none; width: 100%; height: 100%; display: flex; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; overflow-y: auto; }
        .brand { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--gold); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-group { margin-bottom: 15px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; color: #555; margin-bottom: 5px; padding-left: 10px; letter-spacing: 1px; }
        .nav-item { padding: 10px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 12px; font-size: 0.85rem; }
        .nav-item:hover, .nav-item.active { background: var(--gold-dim); color: var(--gold); border-left: 3px solid var(--gold); }
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; }
        .saas-badge { font-size: 0.7rem; color: #444; text-align: center; text-transform: uppercase; letter-spacing: 2px; }

        /* MAIN */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; position: relative; }
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page-title h2 { font-weight: 600; font-size: 1.6rem; color: #fff; font-family: 'Playfair Display', serif; }
        .page-title p { color: var(--text-muted); font-size: 0.85rem; margin-top: 5px; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .date-display { background: var(--panel); padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); color: var(--gold); font-size: 0.9rem; }

        /* CARDS & TABLES */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; margin-bottom: 20px; }
        .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-head i { padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; color: var(--gold); }
        .card-head span { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; }
        .card-val { font-size: 1.8rem; font-weight: 600; color: #fff; }
        .card-trend { font-size: 0.75rem; margin-top: 5px; display: block; }
        .trend-up { color: var(--success); }

        /* FILTER TABS */
        .filter-tabs { display: flex; background: #1a1a1a; padding: 4px; border-radius: 8px; border: 1px solid #333; margin-right: 10px; }
        .filter-tab { background: transparent; border: none; color: #888; padding: 6px 12px; font-size: 0.8rem; cursor: pointer; border-radius: 6px; font-weight: 500; transition: 0.2s; }
        .filter-tab.active { background: var(--gold); color: #000; font-weight: 700; }
        .filter-tab:hover:not(.active) { color: #fff; }

        /* DISPUTA STYLES */
        .champion-card { background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(0,0,0,0) 100%); border: 1px solid var(--gold); text-align: center; }
        .champion-icon { font-size: 2.5rem; color: var(--gold); margin-bottom: 10px; display: block; }
        .rank-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .rank-1 { background: var(--gold); color: #000; }
        .rank-2 { background: #c0c0c0; color: #000; }
        .rank-3 { background: #cd7f32; color: #000; }
        .rank-other { background: #333; color: #aaa; }

        /* METAS DASHBOARD */
        .meta-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .meta-stat { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .meta-stat span { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 5px; }
        .meta-stat strong { font-size: 1.1rem; color: #fff; }
        .progress-container { background: #222; height: 12px; border-radius: 6px; width: 100%; margin-top: 15px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 1s ease-in-out; border-radius: 6px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.9rem; color: #ccc; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .st-pendente { background: rgba(241, 196, 15, 0.15); color: #f1c40f; border: 1px solid rgba(241, 196, 15, 0.3); }
        .st-concluido { background: rgba(46, 204, 113, 0.15); color: #2ecc71; border: 1px solid rgba(46, 204, 113, 0.3); }
        .st-lost { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
        .st-recovered { background: rgba(52, 152, 219, 0.15); color: #3498db; border: 1px solid rgba(52, 152, 219, 0.3); }

        .btn-action { border: 1px solid transparent; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: 0.2s; margin-right: 5px; background: transparent; }
        .btn-check { color: #2ecc71; border-color: rgba(46, 204, 113, 0.3); }
        .btn-check:hover { background: #2ecc71; color: #000; }
        .btn-trash { color: #e74c3c; border-color: rgba(231, 76, 60, 0.3); }
        .btn-trash:hover { background: #e74c3c; color: #fff; }
        .btn-edit { color: #3498db; border-color: rgba(52, 152, 219, 0.3); }
        .btn-edit:hover { background: #3498db; color: #fff; }
        .btn-whatsapp { background: rgba(37, 211, 102, 0.1); color: #25D366; border: 1px solid rgba(37, 211, 102, 0.3); text-decoration: none; display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .btn-whatsapp:hover { background: #25D366; color: #000; }
        .btn-recover { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
        .btn-recover:hover { background: #e74c3c; color: white; }
        .btn-notify { color: #9b59b6; border-color: rgba(155, 89, 182, 0.3); }
        .btn-notify:hover { background: #9b59b6; color: white; }

        .btn-save { background: var(--gold); color: #000; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 20px; width: 100%; transition: 0.3s; }
        .btn-save:hover { background: #bfa145; box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }
        .btn-add { background: var(--gold); color: #000; border: none; padding: 8px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; float: right; }
        .btn-export { background: transparent; color: #ccc; border: 1px solid #444; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; margin-left: 5px; }
        .btn-export:hover { border-color: var(--gold); color: var(--gold); }
        .btn-upload { background: #333; color: #fff; border: 1px dashed #666; padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; transition: 0.2s; }
        .btn-upload:hover { border-color: var(--gold); color: var(--gold); }

        .prof-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #444; }

        /* FORMS & CHARTS */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group label { display: block; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .input-field { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 8px; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: var(--gold); }
        input[type="date"] { color-scheme: dark; }
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 350px; margin-bottom: 20px; }
        .chart-container { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
        .chart-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 15px; color: var(--text); border-left: 3px solid var(--gold); padding-left: 10px; }
        .canvas-wrapper { flex: 1; position: relative; width: 100%; height: 100%; }

        #loading { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 3px solid #333; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #toast { position: fixed; top: 20px; right: 20px; background: #1e1e1e; color: #fff; padding: 15px 25px; border-radius: 8px; border-left: 4px solid var(--gold); transform: translateX(200%); transition: 0.3s; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-size: 0.9rem; }
        #toast.show { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div></div>
    <div id="toast">Ação realizada com sucesso!</div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>BarberLabel</h2>
            <p style="color:#888; margin-bottom:20px; font-size:0.9rem;">Acesso Administrativo</p>
            <input type="text" id="login-user" placeholder="Nome da Barbearia">
            
            <div class="pass-wrapper">
                <input type="password" id="login-pass" placeholder="Senha de Admin">
                <i class="fas fa-eye pass-eye" onclick="toggleLoginPass()"></i>
            </div>

            <button onclick="attemptLogin()">ACESSAR SISTEMA</button>
            <p id="login-error" style="color:var(--danger); font-size:0.8rem; margin-top:10px; display:none;">Dados incorretos.</p>
        </div>
    </div>

    <!-- MODAL DE CONFIRMAÇÃO -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="confirm-box">
            <i class="fas fa-exclamation-circle confirm-icon"></i>
            <h3 class="confirm-title" id="confirm-title">Atenção</h3>
            <p class="confirm-text" id="confirm-msg">Tem certeza?</p>
            <div class="confirm-actions">
                <button class="btn-modal btn-modal-cancel" onclick="resolveConfirm(false)">Cancelar</button>
                <button class="btn-modal btn-modal-confirm" onclick="resolveConfirm(true)">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR SERVIÇO -->
    <div id="edit-service-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Editar Serviço</h3>
            <input type="text" id="edit-svc-name" class="modal-input" placeholder="Nome">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="edit-svc-price" class="modal-input" placeholder="Preço (R$)">
                <input type="number" id="edit-svc-time" class="modal-input" placeholder="Minutos">
            </div>
            <input type="hidden" id="edit-svc-id">
            <div class="modal-actions">
                <button class="btn-modal btn-modal-cancel" onclick="closeEditModal('edit-service-modal')">Cancelar</button>
                <button class="btn-modal btn-modal-confirm" onclick="saveEditedService()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR PROFISSIONAL -->
    <div id="edit-prof-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Editar Profissional</h3>
            <input type="text" id="edit-prof-name" class="modal-input" placeholder="Nome">
            <label style="font-size:0.75rem; color:#aaa; display:block; margin-bottom:5px; text-align:left;">Alterar Foto</label>
            <input type="file" id="edit-prof-img" class="btn-upload" accept="image/*">
            <input type="hidden" id="edit-prof-id">
            <div class="modal-actions">
                <button class="btn-modal btn-modal-cancel" onclick="closeEditModal('edit-prof-modal')">Cancelar</button>
                <button class="btn-modal btn-modal-confirm" onclick="saveEditedProf()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR GASTO -->
    <div id="edit-exp-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Editar Gasto</h3>
            <input type="text" id="edit-exp-desc" class="modal-input" placeholder="Descrição">
            <input type="number" id="edit-exp-val" class="modal-input" placeholder="Valor (R$)">
            <input type="date" id="edit-exp-date" class="modal-input">
            <input type="hidden" id="edit-exp-id">
            <div class="modal-actions">
                <button class="btn-modal btn-modal-cancel" onclick="closeEditModal('edit-exp-modal')">Cancelar</button>
                <button class="btn-modal btn-modal-confirm" onclick="saveEditedExpense()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR PRODUTO -->
    <div id="edit-prod-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Editar Produto</h3>
            <input type="text" id="edit-prod-name" class="modal-input" placeholder="Nome">
            <input type="number" id="edit-prod-price" class="modal-input" placeholder="Preço (R$)">
            <input type="number" id="edit-prod-stock" class="modal-input" placeholder="Estoque">
            <input type="hidden" id="edit-prod-id">
            <div class="modal-actions">
                <button class="btn-modal btn-modal-cancel" onclick="closeEditModal('edit-prod-modal')">Cancelar</button>
                <button class="btn-modal btn-modal-confirm" onclick="saveEditedProduct()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div class="app-content" id="app-interface" style="display:none;">
        <div class="sidebar">
            <div class="brand">
                <i class="fas fa-scissors"></i> <span id="brand-name">BarberLabel</span>
            </div>
            
            <div class="nav-group">
                <div class="nav-label">Gestão</div>
                <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</div>
                <div class="nav-item" onclick="switchView('agenda', this)"><i class="fas fa-calendar-alt"></i> Agenda</div>
                <div class="nav-item" onclick="switchView('leads', this)"><i class="fas fa-user-clock"></i> Recuperar</div>
                <div class="nav-item" onclick="switchView('disputa', this)"><i class="fas fa-trophy"></i> Disputa</div>
            </div>

            <div class="nav-group">
                <div class="nav-label">Administração</div>
                <div class="nav-item" onclick="switchView('servicos', this)"><i class="fas fa-cut"></i> Serviços</div>
                <div class="nav-item" onclick="switchView('profissionais', this)"><i class="fas fa-user-tie"></i> Profissionais</div>
                <div class="nav-item" onclick="switchView('clientes', this)"><i class="fas fa-users"></i> Clientes</div>
            </div>

            <div class="nav-group">
                <div class="nav-label">Loja</div>
                <div class="nav-item" onclick="switchView('compras', this)"><i class="fas fa-shopping-cart"></i> Compras/Gastos</div>
                <div class="nav-item" onclick="switchView('produtos', this)"><i class="fas fa-box-open"></i> Produtos</div>
                <div class="nav-item" onclick="switchView('metas', this)"><i class="fas fa-bullseye"></i> Metas</div>
                <div class="nav-item" onclick="switchView('financeiro', this)"><i class="fas fa-wallet"></i> Financeiro</div>
            </div>

            <div class="nav-item" onclick="switchView('config', this)"><i class="fas fa-cog"></i> Configurações</div>

            <div class="sidebar-footer">
                <div class="saas-badge">POWERED BY<br>BARBERLABEL</div>
            </div>
        </div>

        <div class="main">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-section active">
                <div class="header">
                    <div class="page-title"><h2>Visão Geral</h2><p>Monitoramento em tempo real.</p></div>
                    <div class="header-controls">
                        <div class="filter-tabs">
                            <button class="filter-tab active" onclick="setDashboardFilter('dia')">Dia</button>
                            <button class="filter-tab" onclick="setDashboardFilter('semana')">Semana</button>
                            <button class="filter-tab" onclick="setDashboardFilter('mes')">Mês</button>
                        </div>
                        <input type="date" id="dashboard-date-picker" class="input-field" style="width:auto; padding:8px;" onchange="processDashboard()">
                        <div class="date-display" id="date-display">...</div>
                    </div>
                </div>
                <div class="kpi-grid">
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Faturamento</span><i class="fas fa-dollar-sign"></i></div>
                        <div class="card-val" id="kpi-revenue">...</div>
                        <span class="card-trend trend-up">Selecionado</span>
                    </div>
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Agendamentos</span><i class="fas fa-calendar-check"></i></div>
                        <div class="card-val" id="kpi-count">0</div>
                        <span class="card-trend">Volume</span>
                    </div>
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>A Receber</span><i class="fas fa-clock"></i></div>
                        <div class="card-val" id="kpi-pending" style="color:#f1c40f">...</div>
                        <span class="card-trend">Pendente</span>
                    </div>
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Ticket Médio</span><i class="fas fa-chart-line"></i></div>
                        <div class="card-val" id="kpi-ticket">...</div>
                        <span class="card-trend trend-up">Por Cliente</span>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container"><div class="chart-title">Receita (Período)</div><div class="canvas-wrapper"><canvas id="mainChart"></canvas></div></div>
                    <div class="chart-container"><div class="chart-title">Serviços Mais Pedidos</div><div class="canvas-wrapper"><canvas id="donutChart"></canvas></div></div>
                </div>
                <div class="card" style="margin-top: 50px;">
                    <div class="chart-title">Agendamentos do Período</div>
                    <table>
                        <thead><tr><th>Cliente</th><th>Serviço</th><th>Barbeiro</th><th>Data/Hora</th><th>Valor</th><th>Status</th></tr></thead>
                        <tbody id="live-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- AGENDA -->
            <div id="view-agenda" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Agenda Completa</h2><p>Gerencie horários.</p></div>
                    <input type="date" id="agenda-date-picker" class="input-field" style="width: auto; cursor:pointer;" onchange="renderAgendaTable()">
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Horário</th><th>Cliente</th><th>Serviço</th><th>Barbeiro</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody id="agenda-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- LEADS -->
            <div id="view-leads" class="view-section">
                <div class="header"><div class="page-title"><h2 style="color:#e74c3c">Recuperar Clientes</h2><p>Acessos sem agendamento.</p></div></div>
                <div class="card">
                    <table id="leads-table">
                        <thead><tr><th>Nome</th><th>WhatsApp</th><th>Acessou em</th><th>Situação</th><th>Ação</th></tr></thead>
                        <tbody id="leads-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- DISPUTA -->
            <div id="view-disputa" class="view-section">
                <div class="header"><div class="page-title"><h2>Disputa</h2><p>Ranking de profissionais.</p></div></div>
                <div class="kpi-grid" style="grid-template-columns: 1fr;">
                    <div class="card champion-card">
                        <i class="fas fa-crown champion-icon"></i>
                        <div style="font-size: 0.9rem; color:var(--text-muted);">CAMPEÃO EM FATURAMENTO</div>
                        <div class="card-val" id="disp-champ-name" style="margin-top:5px; color:#fff">...</div>
                        <div id="disp-champ-val" style="color:var(--gold); font-weight:600; font-size:1.2rem;">R$ 0,00</div>
                    </div>
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Posição</th><th>Barbeiro</th><th>Agendamentos</th><th>Cortes</th><th>Faturamento</th></tr></thead>
                        <tbody id="disputa-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- SERVIÇOS (NOVO) -->
            <div id="view-servicos" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Serviços</h2><p>Gerencie preços e cortes.</p></div>
                </div>
                <div class="card">
                    <div class="form-grid" style="margin-bottom:20px; grid-template-columns: 2fr 1fr 1fr auto;">
                        <input type="text" id="new-svc-name" class="input-field" placeholder="Nome do Serviço">
                        <input type="number" id="new-svc-price" class="input-field" placeholder="Preço (R$)">
                        <input type="number" id="new-svc-time" class="input-field" placeholder="Tempo (min)">
                        <button class="btn-add" onclick="addService()"><i class="fas fa-plus"></i> Adicionar</button>
                    </div>
                    <table>
                        <thead><tr><th>Serviço</th><th>Tempo</th><th>Preço</th><th>Ação</th></tr></thead>
                        <tbody id="servicos-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- PROFISSIONAIS (NOVO) -->
            <div id="view-profissionais" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Profissionais</h2><p>Equipe e Acessos.</p></div>
                </div>
                <div class="card">
                    <div class="form-grid" style="margin-bottom:20px; grid-template-columns: 2fr 1fr auto;">
                        <input type="text" id="new-barber-name" class="input-field" placeholder="Nome do Barbeiro">
                        <input type="file" id="new-barber-img" class="btn-upload" accept="image/*">
                        <button class="btn-add" id="btn-add-prof" onclick="addBarber()"><i class="fas fa-plus"></i> Adicionar</button>
                    </div>
                    <table>
                        <thead><tr><th>Foto</th><th>Nome</th><th>Ação</th></tr></thead>
                        <tbody id="profissionais-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- COMPRAS (NOVO) -->
            <div id="view-compras" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Compras & Gastos</h2><p>Controle de despesas.</p></div>
                </div>
                <div class="card">
                    <div class="form-grid" style="margin-bottom:20px;">
                        <input type="text" id="new-exp-desc" class="input-field" placeholder="Descrição (ex: Luz, Água, Toalhas)">
                        <input type="number" id="new-exp-val" class="input-field" placeholder="Valor (R$)">
                        <input type="date" id="new-exp-date" class="input-field">
                        <button class="btn-add" onclick="addExpense()"><i class="fas fa-plus"></i> Lançar Gasto</button>
                    </div>
                    <table>
                        <thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Ação</th></tr></thead>
                        <tbody id="compras-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- PRODUTOS (NOVO) -->
            <div id="view-produtos" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Produtos</h2><p>Venda de balcão (Pomadas, etc).</p></div>
                </div>
                <div class="card">
                    <div class="form-grid" style="margin-bottom:20px; grid-template-columns: 2fr 1fr 1fr auto;">
                        <input type="text" id="new-prod-name" class="input-field" placeholder="Nome do Produto">
                        <input type="number" id="new-prod-price" class="input-field" placeholder="Preço Venda">
                        <input type="number" id="new-prod-stock" class="input-field" placeholder="Qtd Estoque">
                        <button class="btn-add" onclick="addProduct()"><i class="fas fa-plus"></i> Adicionar</button>
                    </div>
                    <table>
                        <thead><tr><th>Produto</th><th>Preço</th><th>Estoque</th><th>Ação</th></tr></thead>
                        <tbody id="produtos-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- METAS DASHBOARD MELHORADO -->
            <div id="view-metas" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Performance</h2><p>Dashboard de Metas.</p></div>
                </div>
                <div class="kpi-grid">
                    <div class="card meta-stat">
                        <span>Faturamento Atual</span>
                        <strong id="meta-current-val" style="color:var(--gold)">R$ 0,00</strong>
                    </div>
                    <div class="card meta-stat">
                        <span>Falta para Meta</span>
                        <strong id="meta-remaining" style="color:var(--text)">R$ 0,00</strong>
                    </div>
                    <div class="card meta-stat">
                        <span>Projeção (Fim Mês)</span>
                        <strong id="meta-projection" style="color:var(--success)">R$ 0,00</strong>
                    </div>
                    <div class="card meta-stat">
                        <span>Média Diária Necessária</span>
                        <strong id="meta-daily-need" style="color:#3498db">R$ 0,00</strong>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:var(--text); font-size:1rem;">Progresso Mensal</h3>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="meta-val" class="input-field" placeholder="Meta R$" style="width:120px; padding:8px;">
                            <button class="btn-save" style="margin:0; padding:8px 15px; font-size:0.8rem;" onclick="saveMeta()">Definir Meta</button>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                        <span>0%</span>
                        <span id="meta-target-text">Meta: R$ 0</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="meta-progress"></div>
                    </div>
                    <p id="meta-pct" style="text-align:center; font-size:1.2rem; color:var(--gold); margin-top:10px; font-weight:700;">0%</p>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="view-clientes" class="view-section">
                <div class="header"><div class="page-title"><h2>Clientes</h2><p>Base de dados.</p></div></div>
                <div class="card">
                    <table>
                        <thead><tr><th>Nome</th><th>WhatsApp</th><th>Visitas</th><th>Última Data</th><th>Ação</th></tr></thead>
                        <tbody id="clientes-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- FINANCEIRO COM EXPORTAÇÃO -->
            <div id="view-financeiro" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Financeiro</h2><p>Extrato de Agendamentos.</p></div>
                    <div>
                        <button class="btn-export" onclick="exportFinancePDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                        <button class="btn-export" onclick="exportFinanceCSV()"><i class="fas fa-file-csv"></i> CSV</button>
                    </div>
                </div>
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card" style="margin-bottom:0"><div class="card-head"><span>Confirmado</span><i class="fas fa-check-circle"></i></div><div class="card-val" id="fin-confirmed" style="color:var(--success)">R$ 0,00</div></div>
                    <div class="card" style="margin-bottom:0"><div class="card-head"><span>Pendente</span><i class="fas fa-hourglass-half"></i></div><div class="card-val" id="fin-potential" style="color:var(--gold)">R$ 0,00</div></div>
                </div>
                <div class="card">
                    <div class="chart-title">Extrato</div>
                    <table>
                        <thead><tr><th>Data</th><th>Cliente</th><th>Serviço</th><th>Barbeiro</th><th>Valor</th></tr></thead>
                        <tbody id="fin-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- CONFIG -->
            <div id="view-config" class="view-section">
                <div class="header"><div class="page-title"><h2>Configurações</h2><p>Dados da Barbearia.</p></div></div>
                <div class="card" style="max-width: 800px;">
                    <div class="form-grid">
                        <div class="input-group"><label>Nome da Barbearia</label><input type="text" id="cfg-nome" class="input-field"></div>
                        <div class="input-group"><label>Endereço</label><input type="text" id="cfg-endereco" class="input-field"></div>
                        <div class="input-group"><label>WhatsApp</label><input type="text" id="cfg-zap" class="input-field"></div>
                        <div class="input-group"><label>Instagram</label><input type="text" id="cfg-insta" class="input-field"></div>
                        <div class="input-group"><label>Abertura</label><input type="time" id="cfg-open" class="input-field"></div>
                        <div class="input-group"><label>Fechamento</label><input type="time" id="cfg-close" class="input-field"></div>
                        <div class="input-group"><label>Senha Admin</label><input type="text" id="cfg-senha" class="input-field"></div>
                    </div>
                    <button class="btn-save" onclick="saveConfig()">SALVAR</button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc, getDoc, setDoc, getDocs, where, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdidGqRySr382mykhZd3G7TqVRwJycsX4",
            authDomain: "app-barbearia-de86f.firebaseapp.com",
            projectId: "app-barbearia-de86f",
            storageBucket: "app-barbearia-de86f.firebasestorage.app",
            messagingSenderId: "67148084464",
            appId: "1:67148084464:web:90a07392ef7330294a3e35",
            measurementId: "G-LE74FLQHHN"
        };
        
        const IMG_BB_KEY = "fde585c6f206d65b90271edd2d43b65e"; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // GLOBALS
        let rawData = [];
        let leadsData = [];
        let appConfig = {}; 
        let expensesList = [];
        let productsList = [];
        let currentMeta = 0;
        let chartMain = null;
        let chartDonut = null;
        let dashboardFilter = 'dia'; 
        
        window.currentView = 'dashboard';
        let loggedIn = false;
        let confirmResolver = null;

        function getPrice(str) {
            if (!str) return 0;
            if (typeof str === 'number') return str;
            let match = str.match(/(?:R\$|PTS)\s*([\d.,]+)/i);
            if (!match) match = str.match(/(\d{2,}[.,]?\d{0,2})$/);
            if (match) {
                let valStr = match[1];
                if(valStr.includes(',') && valStr.includes('.')) valStr = valStr.replace('.', '').replace(',', '.'); 
                else if(valStr.includes(',')) valStr = valStr.replace(',', '.');
                const num = parseFloat(valStr);
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        window.onload = () => {
            const dateDisplay = document.getElementById('date-display');
            if(dateDisplay) dateDisplay.innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            const today = new Date();
            const agendaPicker = document.getElementById('agenda-date-picker');
            const dashPicker = document.getElementById('dashboard-date-picker');
            const expPicker = document.getElementById('new-exp-date');
            
            if(agendaPicker) agendaPicker.valueAsDate = today;
            if(dashPicker) dashPicker.valueAsDate = today;
            if(expPicker) expPicker.valueAsDate = today;
            
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'none';
        };
        
        window.toggleLoginPass = () => {
            const i = document.getElementById('login-pass');
            if(i) i.type = i.type === 'password' ? 'text' : 'password';
        }

        window.showConfirm = (msg) => {
            const txt = document.getElementById('confirm-msg');
            const modal = document.getElementById('confirm-modal');
            if(txt) txt.innerText = msg;
            if(modal) modal.style.display = 'flex';
            return new Promise((resolve) => { confirmResolver = resolve; });
        }
        window.resolveConfirm = (result) => {
            const modal = document.getElementById('confirm-modal');
            if(modal) modal.style.display = 'none';
            if (confirmResolver) confirmResolver(result);
        }

        window.closeEditModal = (id) => {
            document.getElementById(id).style.display = 'none';
        }
        
        async function uploadToImgBB(fileInputId) {
            const fileInput = document.getElementById(fileInputId);
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append("image", file);
                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_KEY}`, { method: "POST", body: formData });
                    const data = await response.json();
                    if(data.success) return data.data.url;
                } catch (error) { console.error("Upload error:", error); }
            }
            return null;
        }

        // LOGIN
        window.attemptLogin = async () => {
            const userEl = document.getElementById('login-user');
            const passEl = document.getElementById('login-pass');
            const errorMsg = document.getElementById('login-error');
            
            const user = userEl ? userEl.value.trim() : "";
            const pass = passEl ? passEl.value.trim() : "";

            if(!user || !pass) { 
                if(errorMsg) { errorMsg.innerText = "Preencha todos os campos."; errorMsg.style.display = 'block'; }
                return; 
            }
            
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'flex';
            
            try {
                const configRef = doc(db, "config", "loja");
                const configSnap = await getDoc(configRef);
                if(!configSnap.exists()) throw new Error("Loja não encontrada.");
                const lojaData = configSnap.data();
                if((lojaData.nomeBarbearia || "").toLowerCase().trim() !== user.toLowerCase()) throw new Error("Nome da barbearia incorreto.");
                
                let authorized = false;
                const senhaAdmin = lojaData.adminPass || "1234";
                if (String(senhaAdmin) === pass) authorized = true;
                
                if(!authorized) throw new Error("Senha incorreta.");
                
                loggedIn = true;
                const brandName = document.getElementById('brand-name');
                if(brandName) brandName.innerText = lojaData.nomeBarbearia;
                
                const loginScreen = document.getElementById('login-screen');
                const appInterface = document.getElementById('app-interface');
                if(loginScreen) loginScreen.style.display = 'none';
                if(appInterface) appInterface.style.display = 'flex';
                
                initListeners();
            } catch(e) {
                if(errorMsg) { errorMsg.innerText = e.message || "Erro."; errorMsg.style.display = 'block'; }
                if(loading) loading.style.display = 'none';
            }
        };

        function initListeners() {
            onSnapshot(doc(db, "config", "loja"), (snap) => {
                if(snap.exists()) {
                    appConfig = snap.data();
                    refreshViews();
                }
            });

            onSnapshot(query(collection(db, "agendamentos"), orderBy("id", "desc")), (snap) => {
                rawData = snap.docs.map(d => ({ firebaseId: d.id, ...d.data() }));
                refreshViews();
                const loading = document.getElementById('loading');
                if(loading) loading.style.display = 'none';
            });
            onSnapshot(query(collection(db, "acessos"), orderBy("timestamp", "desc"), limit(50)), (snap) => {
                leadsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshViews();
            });
            onSnapshot(query(collection(db, "despesas"), orderBy("data", "desc")), (snap) => {
                expensesList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshViews();
            });
            onSnapshot(query(collection(db, "produtos")), (snap) => {
                productsList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshViews();
            });
            onSnapshot(doc(db, "config", "metas"), (snap) => {
                if(snap.exists()) {
                    currentMeta = snap.data().faturamentoMensal || 0;
                    refreshViews();
                }
            });
            
            loadConfig();
        }

        function refreshViews() {
            if(window.currentView === 'dashboard') processDashboard();
            if(window.currentView === 'agenda') renderAgendaTable();
            if(window.currentView === 'clientes') renderClientsTable();
            if(window.currentView === 'financeiro') renderFinanceTable();
            if(window.currentView === 'leads') renderLeadsTable();
            if(window.currentView === 'disputa') renderDisputa();
            if(window.currentView === 'servicos') renderServicesTable();
            if(window.currentView === 'profissionais') renderBarbersTable();
            if(window.currentView === 'compras') renderExpensesTable();
            if(window.currentView === 'produtos') renderProductsTable();
            if(window.currentView === 'metas') renderMetas();
        }

        window.switchView = (viewId, el) => {
            if(!loggedIn) return;
            window.currentView = viewId;
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            const view = document.getElementById('view-' + viewId);
            if(view) view.classList.add('active');
            refreshViews();
            if(viewId === 'config') loadConfig();
        }

        // --- SERVIÇOS (CRUD) ---
        window.addService = async () => {
            const nomeEl = document.getElementById('new-svc-name');
            const valorEl = document.getElementById('new-svc-price');
            const timeEl = document.getElementById('new-svc-time');
            const nome = nomeEl ? nomeEl.value : '';
            const valor = valorEl ? valorEl.value : '';
            const time = timeEl ? timeEl.value : '30';
            
            if(!nome || !valor) return alert("Preencha tudo");
            
            const newService = { id: Date.now(), nome, preco: parseFloat(valor), tempo: parseInt(time) }; 
            const updatedServices = [...(appConfig.servicos || []), newService];
            await updateDoc(doc(db, "config", "loja"), { servicos: updatedServices });
            
            if(nomeEl) nomeEl.value = ''; if(valorEl) valorEl.value = ''; if(timeEl) timeEl.value = '';
            showToast("Serviço adicionado!");
        }
        
        window.openEditService = (id) => {
            const svc = (appConfig.servicos || []).find(s => s.id === id);
            if(!svc) return;
            document.getElementById('edit-svc-name').value = svc.nome;
            document.getElementById('edit-svc-price').value = svc.preco;
            document.getElementById('edit-svc-time').value = svc.tempo || 30;
            document.getElementById('edit-svc-id').value = svc.id;
            document.getElementById('edit-service-modal').style.display = 'flex';
        }
        window.saveEditedService = async () => {
            const id = parseInt(document.getElementById('edit-svc-id').value);
            const nome = document.getElementById('edit-svc-name').value;
            const preco = parseFloat(document.getElementById('edit-svc-price').value);
            const tempo = parseInt(document.getElementById('edit-svc-time').value);
            const updatedServices = (appConfig.servicos || []).map(s => s.id === id ? { ...s, nome, preco, tempo } : s);
            await updateDoc(doc(db, "config", "loja"), { servicos: updatedServices });
            closeEditModal('edit-service-modal');
            showToast("Serviço atualizado!");
        }
        window.deleteServiceItem = async (id) => {
             if(await showConfirm("Remover este serviço?")) {
                const updatedServices = (appConfig.servicos || []).filter(s => s.id !== id);
                await updateDoc(doc(db, "config", "loja"), { servicos: updatedServices });
                showToast("Removido.");
             }
        }
        window.renderServicesTable = () => {
            const tbody = document.getElementById('servicos-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const list = appConfig.servicos || [];
            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            list.forEach(s => {
                const name = s.nome || s.name || 'Sem nome';
                const val = s.preco || s.valor || s.price || 0;
                const time = s.tempo || 30;
                tbody.innerHTML += `<tr><td>${name}</td><td>${time} min</td><td style="color:var(--gold)">R$ ${parseFloat(val).toFixed(2)}</td><td><button class="btn-action btn-edit" onclick="openEditService(${s.id})"><i class="fas fa-pen"></i></button><button class="btn-action btn-trash" onclick="deleteServiceItem(${s.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- PROFISSIONAIS (CRUD) ---
        window.addBarber = async () => {
            const nomeEl = document.getElementById('new-barber-name');
            const nome = nomeEl ? nomeEl.value : '';
            if(!nome) return alert("Preencha o nome");
            
            const btn = document.getElementById('btn-add-prof');
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i>";
            
            let imgUrl = "https://placehold.co/150/444444/FFF?text=" + nome.charAt(0);
            const uploadedUrl = await uploadToImgBB('new-barber-img');
            if(uploadedUrl) imgUrl = uploadedUrl;

            const newProf = { id: Date.now(), nome, foto: imgUrl };
            const updatedProfs = [...(appConfig.profissionais || []), newProf];
            await updateDoc(doc(db, "config", "loja"), { profissionais: updatedProfs });
            
            if(nomeEl) nomeEl.value = ''; document.getElementById('new-barber-img').value = '';
            btn.innerHTML = "<i class='fas fa-plus'></i> Adicionar";
            showToast("Barbeiro adicionado!");
        }

        window.openEditProf = (id) => {
            const prof = (appConfig.profissionais || []).find(p => p.id === id);
            if(!prof) return;
            document.getElementById('edit-prof-name').value = prof.nome;
            document.getElementById('edit-prof-id').value = prof.id;
            document.getElementById('edit-prof-modal').style.display = 'flex';
        }
        
        window.saveEditedProf = async () => {
            const id = parseInt(document.getElementById('edit-prof-id').value);
            const nome = document.getElementById('edit-prof-name').value;
            
            let currentProf = (appConfig.profissionais || []).find(p => p.id === id);
            let imgUrl = currentProf.foto;
            const uploadedUrl = await uploadToImgBB('edit-prof-img');
            if(uploadedUrl) imgUrl = uploadedUrl;

            const updatedProfs = (appConfig.profissionais || []).map(p => p.id === id ? { ...p, nome, foto: imgUrl } : p);
            await updateDoc(doc(db, "config", "loja"), { profissionais: updatedProfs });
            closeEditModal('edit-prof-modal');
            showToast("Profissional atualizado!");
        }

        window.deleteBarberItem = async (id) => {
             if(await showConfirm("Remover este profissional?")) {
                const updatedProfs = (appConfig.profissionais || []).filter(p => p.id !== id);
                await updateDoc(doc(db, "config", "loja"), { profissionais: updatedProfs });
                showToast("Removido.");
             }
        }
        window.renderBarbersTable = () => {
            const tbody = document.getElementById('profissionais-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const list = appConfig.profissionais || [];
            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            list.forEach(b => {
                const name = b.nome || 'Sem nome';
                const img = b.foto || 'https://placehold.co/150';
                tbody.innerHTML += `<tr><td><img src="${img}" class="prof-avatar"></td><td>${name}</td><td><button class="btn-action btn-edit" onclick="openEditProf(${b.id})"><i class="fas fa-pen"></i></button><button class="btn-action btn-trash" onclick="deleteBarberItem(${b.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- COMPRAS/GASTOS (CRUD) ---
        window.addExpense = async () => {
            const desc = document.getElementById('new-exp-desc').value;
            const val = document.getElementById('new-exp-val').value;
            const date = document.getElementById('new-exp-date').value;
            if(!desc || !val || !date) return alert("Preencha tudo");
            await addDoc(collection(db, "despesas"), { descricao: desc, valor: parseFloat(val), data: date });
            showToast("Gasto lançado!");
        }
        window.openEditExpense = (id) => {
            const exp = expensesList.find(e => e.id === id);
            if(!exp) return;
            document.getElementById('edit-exp-desc').value = exp.descricao;
            document.getElementById('edit-exp-val').value = exp.valor;
            document.getElementById('edit-exp-date').value = exp.data;
            document.getElementById('edit-exp-id').value = exp.id;
            document.getElementById('edit-exp-modal').style.display = 'flex';
        }
        window.saveEditedExpense = async () => {
            const id = document.getElementById('edit-exp-id').value;
            const desc = document.getElementById('edit-exp-desc').value;
            const val = parseFloat(document.getElementById('edit-exp-val').value);
            const date = document.getElementById('edit-exp-date').value;
            await updateDoc(doc(db, "despesas", id), { descricao: desc, valor: val, data: date });
            closeEditModal('edit-exp-modal');
            showToast("Gasto atualizado!");
        }
        window.renderExpensesTable = () => {
            const tbody = document.getElementById('compras-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            if(expensesList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            expensesList.forEach(e => {
                const d = (e.data || '2023-01-01').split('-');
                const dateStr = d.length === 3 ? `${d[2]}/${d[1]}/${d[0]}` : e.data;
                const val = e.valor || 0;
                tbody.innerHTML += `<tr><td>${dateStr}</td><td>${e.descricao}</td><td style="color:var(--danger)">R$ ${parseFloat(val).toFixed(2)}</td><td><button class="btn-action btn-edit" onclick="openEditExpense('${e.id}')"><i class="fas fa-pen"></i></button><button class="btn-action btn-trash" onclick="deleteDoc(doc(db,'despesas','${e.id}'))"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- PRODUTOS (CRUD) ---
        window.addProduct = async () => {
            const nome = document.getElementById('new-prod-name').value;
            const price = document.getElementById('new-prod-price').value;
            const stock = document.getElementById('new-prod-stock').value;
            if(!nome) return alert("Nome obrigatório");
            await addDoc(collection(db, "produtos"), { nome, valor: parseFloat(price||0), estoque: parseInt(stock||0) });
            showToast("Produto salvo!");
        }
        window.openEditProduct = (id) => {
            const prod = productsList.find(p => p.id === id);
            if(!prod) return;
            document.getElementById('edit-prod-name').value = prod.nome;
            document.getElementById('edit-prod-price').value = prod.valor;
            document.getElementById('edit-prod-stock').value = prod.estoque;
            document.getElementById('edit-prod-id').value = prod.id;
            document.getElementById('edit-prod-modal').style.display = 'flex';
        }
        window.saveEditedProduct = async () => {
            const id = document.getElementById('edit-prod-id').value;
            const nome = document.getElementById('edit-prod-name').value;
            const val = parseFloat(document.getElementById('edit-prod-price').value);
            const stock = parseInt(document.getElementById('edit-prod-stock').value);
            await updateDoc(doc(db, "produtos", id), { nome, valor: val, estoque: stock });
            closeEditModal('edit-prod-modal');
            showToast("Produto atualizado!");
        }
        window.renderProductsTable = () => {
            const tbody = document.getElementById('produtos-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            if(productsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            productsList.forEach(p => {
                const val = p.valor || 0;
                const stock = p.estoque || 0;
                tbody.innerHTML += `<tr><td>${p.nome}</td><td style="color:var(--gold)">R$ ${parseFloat(val).toFixed(2)}</td><td>${stock}</td><td><button class="btn-action btn-edit" onclick="openEditProduct('${p.id}')"><i class="fas fa-pen"></i></button><button class="btn-action btn-trash" onclick="deleteDoc(doc(db,'produtos','${p.id}'))"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- DASHBOARD FILTERS ---
        window.setDashboardFilter = (filter) => {
            dashboardFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
            const index = filter === 'dia' ? 0 : filter === 'semana' ? 1 : 2;
            document.querySelectorAll('.filter-tab')[index].classList.add('active');
            processDashboard();
        }

        window.processDashboard = () => {
            const dateInput = document.getElementById('dashboard-date-picker');
            let selectedDateStr = "";
            let startFilter, endFilter;
            
            const now = new Date();
            if(dashboardFilter === 'dia') {
                if(dateInput && dateInput.value) {
                    const [y, m, d] = dateInput.value.split('-');
                    selectedDateStr = `${d}/${m}/${y}`;
                } else {
                    selectedDateStr = now.toLocaleDateString('pt-BR');
                }
            } else if (dashboardFilter === 'semana') {
                const first = now.getDate() - now.getDay(); 
                const last = first + 6;
                startFilter = new Date(now.setDate(first));
                endFilter = new Date(now.setDate(last));
            } else if (dashboardFilter === 'mes') {
                 // Month logic handled in loop
            }

            let totalRev = 0, totalPending = 0, selectedDateCount = 0, selectedDateRevenue = 0, selectedDatePending = 0;
            let selectedDateItems = [];
            const daysMap = {};
            const pieMap = {};
            
            // Build last 7 days map for chart
            for(let i=6; i>=0; i--) { 
                const d = new Date(); d.setDate(new Date().getDate() - i); 
                daysMap[d.toLocaleDateString('pt-BR')] = 0; 
            }

            rawData.forEach(item => {
                const price = getPrice(item.servico);
                // Chart Data (Last 7 days)
                if(daysMap.hasOwnProperty(item.data)) daysMap[item.data] += (item.status==='concluido'?price:0);
                if(item.status === 'concluido') {
                    const sName = item.servico.split('(')[0].split('R$')[0].trim();
                    pieMap[sName] = (pieMap[sName] || 0) + 1;
                }
                
                // Dashboard Logic
                let include = false;
                if(dashboardFilter === 'dia') {
                    if(item.data === selectedDateStr) include = true;
                } else if(dashboardFilter === 'semana') {
                    const [d, m, y] = item.data.split('/');
                    const itemDate = new Date(y, m-1, d);
                    const diffTime = Math.abs(new Date() - itemDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    if(diffDays <= 7) include = true;
                } else if(dashboardFilter === 'mes') {
                    const [d, m, y] = item.data.split('/');
                    if(parseInt(m) === (new Date().getMonth() + 1) && parseInt(y) === new Date().getFullYear()) include = true;
                }

                if(include) {
                    selectedDateCount++;
                    selectedDateRevenue += price; 
                    if(item.status !== 'concluido') selectedDatePending += price;
                    selectedDateItems.push(item);
                }
            });

            const kpiRevenue = document.getElementById('kpi-revenue');
            const kpiCount = document.getElementById('kpi-count');
            const kpiPending = document.getElementById('kpi-pending');
            const kpiTicket = document.getElementById('kpi-ticket');

            if(kpiRevenue) kpiRevenue.innerText = `R$ ${selectedDateRevenue.toFixed(2)}`;
            if(kpiCount) kpiCount.innerText = selectedDateCount;
            if(kpiPending) kpiPending.innerText = `R$ ${selectedDatePending.toFixed(2)}`;
            
            const ticket = selectedDateCount ? selectedDateRevenue / selectedDateCount : 0;
            if(kpiTicket) kpiTicket.innerText = `R$ ${ticket.toFixed(2)}`;

            const tbody = document.getElementById('live-table-body');
            if(tbody) {
                tbody.innerHTML = '';
                if(selectedDateItems.length === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nenhum registro encontrado.</td></tr>';
                selectedDateItems.sort((a,b)=>a.hora.localeCompare(b.hora)).forEach(item => {
                    const price = getPrice(item.servico);
                    const st = item.status==='concluido'?'st-concluido':'st-pendente';
                    tbody.innerHTML += `<tr><td>${item.cliente}</td><td>${item.servico.split('(')[0]}</td><td>${item.barbeiro}</td><td>${item.hora}</td><td style="color:var(--gold)">R$ ${price}</td><td><span class="status-pill ${st}">${item.status}</span></td></tr>`;
                });
            }

            renderCharts(daysMap, pieMap);
        }

        function renderCharts(lineData, pieData) {
            const ctx1 = document.getElementById('mainChart');
            if (ctx1) {
                if (chartMain) chartMain.destroy();
                let gradient = ctx1.getContext('2d').createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(212, 175, 55, 0.4)');
                gradient.addColorStop(1, 'rgba(212, 175, 55, 0.0)');

                chartMain = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: Object.keys(lineData).map(d => d.substring(0, 5)), 
                        datasets: [{
                            label: 'Receita',
                            data: Object.values(lineData),
                            borderColor: '#d4af37', 
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { grid: { color: '#333' }, ticks: { color: '#888' } },
                            x: { grid: { display: false }, ticks: { color: '#888' } }
                        }
                    }
                });
            }

            const ctx2 = document.getElementById('donutChart');
            if (ctx2) {
                if (chartDonut) chartDonut.destroy();
                chartDonut = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(pieData),
                        datasets: [{
                            data: Object.values(pieData),
                            backgroundColor: ['#d4af37', '#f1c40f', '#e67e22', '#3498db'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#888', boxWidth: 10 } }
                        },
                        cutout: '70%'
                    }
                });
            }
        }

        // --- EXPORTAR FINANCEIRO ---
        window.exportFinanceCSV = () => {
            let csv = "Data,Cliente,Serviço,Barbeiro,Valor,Status\n";
            rawData.forEach(item => {
                const val = getPrice(item.servico);
                csv += `${item.data},${item.cliente},${item.servico.replace(',','')},${item.barbeiro},${val},${item.status}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.hidden = true; a.href = url; a.download = 'financeiro.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        window.exportFinancePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Relatório Financeiro", 14, 20);
            const tableData = rawData.map(item => [item.data, item.cliente, item.barbeiro, `R$ ${getPrice(item.servico).toFixed(2)}`, item.status]);
            doc.autoTable({ head: [['Data', 'Cliente', 'Barbeiro', 'Valor', 'Status']], body: tableData, startY: 30 });
            doc.save('financeiro.pdf');
        }

        // GENERIC RENDERERS
        window.renderAgendaTable = () => {
            const picker = document.getElementById('agenda-date-picker');
            if(!picker) return;
            const dateStr = picker.value.split('-').reverse().join('/');
            const tbody = document.getElementById('agenda-table-body');
            if(!tbody) return;
            
            tbody.innerHTML = '';
            const filtered = rawData.filter(i => i.data === dateStr).sort((a,b)=>a.hora.localeCompare(b.hora));
            if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Nenhum registro encontrado.</td></tr>'; return; }
            filtered.forEach(item => {
                const price = getPrice(item.servico);
                const isDone = item.status === 'concluido';
                const notifyBtn = !isDone ? `<button class="btn-action btn-notify" onclick="sendPushReminder('${item.firebaseId}', '${item.cliente}')"><i class="fas fa-bell"></i></button>` : '';
                const checkBtn = !isDone ? `<button class="btn-action btn-check" onclick="updateStatus('${item.firebaseId}', 'concluido')"><i class="fas fa-check"></i></button>` : '';
                const trashBtn = `<button class="btn-action btn-trash" onclick="deleteAppt('${item.firebaseId}')"><i class="fas fa-trash"></i></button>`;
                const zapBtn = `<a href="https://wa.me/${item.zapUsuario || ''}" target="_blank" class="btn-action btn-whatsapp" style="margin-right:5px;"><i class="fab fa-whatsapp"></i></a>`;
                
                tbody.innerHTML += `<tr><td>${item.hora}</td><td>${item.cliente}</td><td>${item.servico.split('(')[0]}</td><td>${item.barbeiro}</td><td style="color:var(--gold)">R$ ${price}</td><td><span class="status-pill ${isDone?'st-concluido':'st-pendente'}">${item.status}</span></td><td>${zapBtn}${checkBtn}${notifyBtn}${trashBtn}</td></tr>`;
            });
        }

        window.renderLeadsTable = () => {
            const tbody = document.getElementById('leads-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const agendadosZaps = new Set(rawData.map(a => a.zapUsuario));
            if(leadsData.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum registro encontrado.</td></tr>'; return; }
            leadsData.forEach(lead => {
                const converteu = agendadosZaps.has(lead.zap);
                let actionHtml = converteu ? 
                    `<button onclick="deleteLead('${lead.id}')" class="btn-action btn-trash"><i class="fas fa-trash"></i></button>` : 
                    `<a href="https://wa.me/${lead.zap}" target="_blank" class="btn-action btn-whatsapp"><i class="fab fa-whatsapp"></i> Chamar</a> <button onclick="deleteLead('${lead.id}')" class="btn-action btn-trash"><i class="fas fa-trash"></i></button>`;
                tbody.innerHTML += `<tr><td>${lead.nome}</td><td>${lead.zap}</td><td>${lead.data} ${lead.hora}</td><td><span class="status-pill ${converteu?'st-recovered':'st-lost'}">${converteu?'Agendou':'Pendente'}</span></td><td>${actionHtml}</td></tr>`;
            });
        }

        window.renderDisputa = () => {
            const tbody = document.getElementById('disputa-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const stats = {};
            const listaProfs = appConfig.profissionais || [];
            
            if (listaProfs.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum profissional cadastrado.</td></tr>';
                 return;
            }

            listaProfs.forEach(b => { 
                const name = b.nome || 'Profissional';
                stats[name] = { nome: name, agend: 0, cortes: 0, rev: 0 }; 
            });
            
            rawData.forEach(item => {
                const barb = item.barbeiro || 'Desconhecido';
                if(!stats[barb]) stats[barb] = { nome: barb, agend: 0, cortes: 0, rev: 0 };
                stats[barb].agend++;
                if(item.status === 'concluido') {
                    stats[barb].cortes++;
                    stats[barb].rev += getPrice(item.servico);
                }
            });

            const rank = Object.values(stats).sort((a,b) => b.rev - a.rev);
            
            const champName = document.getElementById('disp-champ-name');
            const champVal = document.getElementById('disp-champ-val');
            
            if(rank.length > 0) {
                if(champName) champName.innerText = rank[0].nome;
                if(champVal) champVal.innerText = `R$ ${rank[0].rev.toFixed(2)}`;
            }
            rank.forEach((r, i) => {
                tbody.innerHTML += `<tr><td>#${i+1}</td><td style="color:#fff">${r.nome}</td><td>${r.agend}</td><td>${r.cortes}</td><td style="color:var(--gold)">R$ ${r.rev.toFixed(2)}</td></tr>`;
            });
        }

        window.renderMetas = () => {
            const now = new Date();
            const currentMonth = now.getMonth(); 
            const currentYear = now.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const currentDay = now.getDate();
            const daysLeft = Math.max(0, daysInMonth - currentDay);

            let revenueMonth = 0;
            
            rawData.forEach(item => {
                if(item.status === 'concluido') {
                    let parts = item.data.includes('/') ? item.data.split('/') : item.data.split('-');
                    let m, y;
                    if(item.data.includes('/')) { m = parseInt(parts[1])-1; y = parseInt(parts[2]); }
                    else { m = parseInt(parts[1])-1; y = parseInt(parts[0]); }
                    
                    if(m === currentMonth && y === currentYear) {
                        revenueMonth += getPrice(item.servico);
                    }
                }
            });

            const remaining = Math.max(0, currentMeta - revenueMonth);
            const avgDaily = currentDay > 0 ? revenueMonth / currentDay : 0;
            const projected = avgDaily * daysInMonth;
            const dailyNeed = daysLeft > 0 ? remaining / daysLeft : 0;

            const elCurrentVal = document.getElementById('meta-current-val');
            const elRemaining = document.getElementById('meta-remaining');
            const elProjection = document.getElementById('meta-projection');
            const elDailyNeed = document.getElementById('meta-daily-need');
            const elMetaInput = document.getElementById('meta-val');
            const elTargetText = document.getElementById('meta-target-text');
            const elProgress = document.getElementById('meta-progress');
            const elPct = document.getElementById('meta-pct');

            if(elCurrentVal) elCurrentVal.innerText = `R$ ${revenueMonth.toFixed(2)}`;
            if(elRemaining) elRemaining.innerText = `R$ ${remaining.toFixed(2)}`;
            if(elProjection) elProjection.innerText = `R$ ${projected.toFixed(2)}`;
            if(elDailyNeed) elDailyNeed.innerText = `R$ ${dailyNeed.toFixed(2)}`;

            if(elMetaInput) elMetaInput.value = currentMeta;
            if(elTargetText) elTargetText.innerText = `Meta: R$ ${currentMeta.toFixed(2)}`;
            
            const pct = currentMeta > 0 ? (revenueMonth / currentMeta) * 100 : 0;
            const finalPct = Math.min(pct, 100);
            
            if(elProgress) elProgress.style.width = `${finalPct}%`;
            if(elPct) elPct.innerText = `${pct.toFixed(1)}%`;
            
            if(elProjection) {
                if(projected >= currentMeta) elProjection.style.color = 'var(--success)';
                else elProjection.style.color = 'var(--danger)'; 
            }
        }
        
        window.saveMeta = async () => {
            const valEl = document.getElementById('meta-val');
            const val = valEl ? valEl.value : '';
            if(!val) return;
            await setDoc(doc(db, "config", "metas"), { faturamentoMensal: parseFloat(val) }, { merge: true });
            showToast("Meta definida!");
        }

        window.renderClientsTable = () => {
            const tbody = document.getElementById('clientes-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            if (rawData.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum cliente encontrado.</td></tr>';
                 return;
            }

            const map = {};
            rawData.forEach(item => {
                const key = item.zapUsuario || item.cliente;
                if(!map[key]) map[key] = { nome: item.cliente, zap: item.zapUsuario, count: 0, last: '' };
                map[key].count++; map[key].last = item.data;
            });
            Object.values(map).forEach(c => {
                const zapBtn = c.zap ? `<a href="https://wa.me/${c.zap}" target="_blank" class="btn-action btn-whatsapp" style="margin-right:5px;"><i class="fab fa-whatsapp"></i></a>` : '';
                tbody.innerHTML += `<tr><td>${c.nome}</td><td>${c.zap||'-'}</td><td>${c.count}</td><td>${c.last}</td><td>${zapBtn}<button onclick="deleteClient('${c.zap}')" class="btn-action btn-trash"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        window.renderFinanceTable = () => {
            const tbody = document.getElementById('fin-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            let conf = 0, pend = 0;
            [...rawData].sort((a,b)=>b.id-a.id).forEach(item => {
                const price = getPrice(item.servico);
                if(item.status === 'concluido') conf += price; else pend += price;
                tbody.innerHTML += `<tr><td>${item.data}</td><td>${item.cliente}</td><td>${item.servico.split('(')[0]}</td><td>${item.barbeiro}</td><td style="color:var(--gold)">R$ ${price}</td></tr>`;
            });
            const finConf = document.getElementById('fin-confirmed');
            const finPend = document.getElementById('fin-potential');
            if(finConf) finConf.innerText = `R$ ${conf.toFixed(2)}`;
            if(finPend) finPend.innerText = `R$ ${pend.toFixed(2)}`;
        }

        // UTILS & DB WRITES
        window.sendPushReminder = async (id, name) => {
            if(await showConfirm(`Enviar notificação para ${name}?`)) {
                try {
                    const item = rawData.find(i => i.firebaseId === id);
                    if(item && item.zapUsuario) {
                        await addDoc(collection(db, "notificacoes"), { 
                            destinatario: item.zapUsuario, 
                            titulo: "Lembrete de Agendamento", 
                            mensagem: `Olá ${name}, seu horário é às ${item.hora}. Estamos te esperando!`,
                            icon: "https://cdn-icons-png.flaticon.com/512/1048/1048953.png",
                            url: "/", 
                            click_action: "/", 
                            lida: false, 
                            data: new Date().toISOString() 
                        });
                    }
                    await updateDoc(doc(db, "agendamentos", id), { lembreteEnviado: new Date().toISOString() });
                    showToast("Notificação enviada!");
                } catch(e) { alert(e); }
            }
        }

        window.deleteLead = async (id) => { if(await showConfirm("Apagar lead?")) { await deleteDoc(doc(db, "acessos", id)); showToast("Apagado!"); } }
        window.deleteClient = async (zap) => { if(await showConfirm("Apagar histórico deste cliente?")) { const toDel = rawData.filter(i=>i.zapUsuario===zap); for(const i of toDel) await deleteDoc(doc(db,"agendamentos",i.firebaseId)); showToast("Apagado!"); } }
        window.updateStatus = async (id, s) => { if(await showConfirm("Confirmar?")) { await updateDoc(doc(db, "agendamentos", id), { status: s }); showToast("Ok!"); } }
        window.deleteAppt = async (id) => { if(await showConfirm("Apagar?")) { await deleteDoc(doc(db, "agendamentos", id)); showToast("Apagado!"); } }
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.db = db;
        
        window.loadConfig = async () => {
            const snap = await getDoc(doc(db, "config", "loja"));
            if (snap.exists()) {
                const d = snap.data();
                if(loggedIn) {
                    const brand = document.getElementById('brand-name');
                    if(brand) brand.innerText = d.nomeBarbearia || 'BarberLabel';
                }
                ['nome','endereco','zap','insta','open','close','senha'].forEach(k => {
                    const el = document.getElementById('cfg-'+k);
                    if(el) el.value = d[k==='nome'?'nomeBarbearia':k==='zap'?'whatsapp':k==='insta'?'instagram':k==='open'?'openTime':k==='close'?'closeTime':k] || '';
                });
            }
        }
        window.saveConfig = async () => {
            const nomeEl = document.getElementById('cfg-nome');
            const endEl = document.getElementById('cfg-endereco');
            const zapEl = document.getElementById('cfg-zap');
            const instaEl = document.getElementById('cfg-insta');
            const openEl = document.getElementById('cfg-open');
            const closeEl = document.getElementById('cfg-close');
            const senhaEl = document.getElementById('cfg-senha');

            const updatedConfig = { 
                ...appConfig,
                nomeBarbearia: nomeEl ? nomeEl.value : '', 
                endereco: endEl ? endEl.value : '', 
                whatsapp: zapEl ? zapEl.value : '', 
                instagram: instaEl ? instaEl.value : '', 
                openTime: openEl ? openEl.value : '', 
                closeTime: closeEl ? closeEl.value : '', 
                adminPass: (senhaEl && senhaEl.value) ? senhaEl.value : "1234" 
            };
            try { await setDoc(doc(db, "config", "loja"), updatedConfig, { merge: true }); showToast("Salvo!"); } catch(e) { alert(e); }
        }
        function showToast(m) { 
            const t=document.getElementById('toast'); 
            if(t) {
                t.innerText=m; 
                t.classList.add('show'); 
                setTimeout(()=>t.classList.remove('show'), 3000); 
            }
        }
    </script>
</body>
</html>
