<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberLabel - Command Center</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --gold-dim: rgba(212, 175, 55, 0.1);
            --bg: #0a0a0a;
            --panel: #141414;
            --border: #222;
            --text: #e0e0e0;
            --text-muted: #888;
            --success: #2ecc71;
            --danger: #e74c3c;
            --input-bg: #1f1f1f;
        }

        /* SCROLL INVISÍVEL */
        /* Chrome, Safari, Opera */
        ::-webkit-scrollbar {
            display: none;
        }
        /* IE, Edge, Firefox */
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; 
        }

        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* MODAL DE CONFIRMAÇÃO (CUSTOM POP-UP) */
        #confirm-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 4000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        .confirm-box {
            background: var(--panel); border: 1px solid var(--gold); border-radius: 12px;
            padding: 30px; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.15);
            transform: scale(0.9); animation: scaleUp 0.2s ease-out forwards;
        }
        @keyframes scaleUp { to { transform: scale(1); } }
        .confirm-icon { font-size: 3rem; color: var(--gold); margin-bottom: 15px; }
        .confirm-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: #fff; margin-bottom: 10px; }
        .confirm-text { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px; }
        .confirm-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-modal { padding: 10px 25px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; transition: 0.3s; flex: 1; }
        .btn-modal-cancel { background: transparent; border: 1px solid #333; color: #888; }
        .btn-modal-cancel:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .btn-modal-confirm { background: var(--gold); color: #000; }
        .btn-modal-confirm:hover { background: #bfa145; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .login-box {
            background: var(--panel); border: 1px solid var(--border);
            padding: 40px; border-radius: 12px; width: 100%; max-width: 400px;
            text-align: center;
        }
        .login-box h2 { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 20px; }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: var(--input-bg); border: 1px solid var(--border);
            color: white; border-radius: 6px; outline: none;
        }
        .login-box button {
            width: 100%; padding: 12px; background: var(--gold); border: none;
            border-radius: 6px; font-weight: 600; cursor: pointer;
        }
        .app-content { display: none; width: 100%; height: 100%; display: flex; } /* Initially hidden */

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .brand { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--gold); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 12px; font-size: 0.9rem; }
        .nav-item:hover, .nav-item.active { background: var(--gold-dim); color: var(--gold); border-left: 3px solid var(--gold); }
        
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; }
        .saas-badge { font-size: 0.7rem; color: #444; text-align: center; text-transform: uppercase; letter-spacing: 2px; }

        /* MAIN */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; position: relative; }
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page-title h2 { font-weight: 600; font-size: 1.6rem; color: #fff; font-family: 'Playfair Display', serif; }
        .page-title p { color: var(--text-muted); font-size: 0.85rem; margin-top: 5px; }
        
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .date-display { background: var(--panel); padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); color: var(--gold); font-size: 0.9rem; }

        /* CARDS & TABLES */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; margin-bottom: 20px; }
        .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-head i { padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; color: var(--gold); }
        .card-head span { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; }
        .card-val { font-size: 1.8rem; font-weight: 600; color: #fff; }
        .card-trend { font-size: 0.75rem; margin-top: 5px; display: block; }
        .trend-up { color: var(--success); }

        /* DISPUTA STYLES */
        .champion-card { background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(0,0,0,0) 100%); border: 1px solid var(--gold); text-align: center; }
        .champion-icon { font-size: 2.5rem; color: var(--gold); margin-bottom: 10px; display: block; }
        .rank-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .rank-1 { background: var(--gold); color: #000; }
        .rank-2 { background: #c0c0c0; color: #000; } /* Prata */
        .rank-3 { background: #cd7f32; color: #000; } /* Bronze */
        .rank-other { background: #333; color: #aaa; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.9rem; color: #ccc; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .st-pendente { background: rgba(241, 196, 15, 0.15); color: #f1c40f; border: 1px solid rgba(241, 196, 15, 0.3); }
        .st-concluido { background: rgba(46, 204, 113, 0.15); color: #2ecc71; border: 1px solid rgba(46, 204, 113, 0.3); }
        .st-lost { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
        .st-recovered { background: rgba(52, 152, 219, 0.15); color: #3498db; border: 1px solid rgba(52, 152, 219, 0.3); }

        .btn-action { border: 1px solid transparent; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: 0.2s; margin-right: 5px; background: transparent; }
        .btn-check { color: #2ecc71; border-color: rgba(46, 204, 113, 0.3); }
        .btn-check:hover { background: #2ecc71; color: #000; }
        .btn-trash { color: #e74c3c; border-color: rgba(231, 76, 60, 0.3); }
        .btn-trash:hover { background: #e74c3c; color: #fff; }
        .btn-whatsapp { background: rgba(37, 211, 102, 0.1); color: #25D366; border: 1px solid rgba(37, 211, 102, 0.3); text-decoration: none; display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .btn-whatsapp:hover { background: #25D366; color: #000; }
        .btn-recover { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
        .btn-recover:hover { background: #e74c3c; color: white; }
        
        .btn-notify { color: #9b59b6; border-color: rgba(155, 89, 182, 0.3); }
        .btn-notify:hover { background: #9b59b6; color: white; }

        .btn-save { background: var(--gold); color: #000; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 20px; width: 100%; transition: 0.3s; }
        .btn-save:hover { background: #bfa145; box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }

        /* FORMS & CHARTS */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group label { display: block; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .input-field { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 8px; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: var(--gold); }
        input[type="date"] { color-scheme: dark; }
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 350px; margin-bottom: 20px; }
        .chart-container { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
        .chart-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 15px; color: var(--text); border-left: 3px solid var(--gold); padding-left: 10px; }
        .canvas-wrapper { flex: 1; position: relative; width: 100%; height: 100%; }

        #loading { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 3px solid #333; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #toast { position: fixed; top: 20px; right: 20px; background: #1e1e1e; color: #fff; padding: 15px 25px; border-radius: 8px; border-left: 4px solid var(--gold); transform: translateX(200%); transition: 0.3s; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-size: 0.9rem; }
        #toast.show { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div></div>
    <div id="toast">Ação realizada com sucesso!</div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>BarberLabel</h2>
            <p style="color:#888; margin-bottom:20px; font-size:0.9rem;">Acesso Administrativo</p>
            <input type="text" id="login-user" placeholder="Nome da Barbearia (Usuário)">
            <input type="password" id="login-pass" placeholder="Senha de Admin">
            <button onclick="attemptLogin()">ACESSAR SISTEMA</button>
            <p id="login-error" style="color:var(--danger); font-size:0.8rem; margin-top:10px; display:none;">Dados incorretos.</p>
        </div>
    </div>

    <!-- POP-UP CONFIRMAÇÃO (CUSTOM) -->
    <div id="confirm-modal">
        <div class="confirm-box">
            <i class="fas fa-exclamation-circle confirm-icon"></i>
            <h3 class="confirm-title" id="confirm-title">Atenção</h3>
            <p class="confirm-text" id="confirm-msg">Tem certeza que deseja realizar esta ação?</p>
            <div class="confirm-actions">
                <button class="btn-modal btn-modal-cancel" onclick="resolveConfirm(false)">Cancelar</button>
                <button class="btn-modal btn-modal-confirm" onclick="resolveConfirm(true)">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- APP CONTENT (Oculto até login) -->
    <div class="app-content" id="app-interface" style="display:none;">
        <div class="sidebar">
            <div class="brand">
                <i class="fas fa-scissors"></i> <span id="brand-name">BarberLabel</span>
            </div>
            
            <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</div>
            <div class="nav-item" onclick="switchView('agenda', this)"><i class="fas fa-calendar-alt"></i> Agenda</div>
            <div class="nav-item" onclick="switchView('leads', this)"><i class="fas fa-user-clock"></i> Recuperar</div>
            <div class="nav-item" onclick="switchView('disputa', this)"><i class="fas fa-trophy"></i> Disputa</div>
            
            <div class="nav-item" onclick="switchView('clientes', this)"><i class="fas fa-users"></i> Clientes</div>
            <div class="nav-item" onclick="switchView('financeiro', this)"><i class="fas fa-wallet"></i> Financeiro</div>
            <div class="nav-item" onclick="switchView('config', this)"><i class="fas fa-cog"></i> Configurações</div>

            <div class="sidebar-footer">
                <div class="saas-badge">POWERED BY<br>BARBERLABEL</div>
            </div>
        </div>

        <div class="main">
            
            <div id="view-dashboard" class="view-section active">
                <div class="header">
                    <div class="page-title"><h2>Visão Geral</h2><p>Monitoramento em tempo real.</p></div>
                    <div class="header-controls">
                        <input type="date" id="dashboard-date-picker" class="input-field" style="width:auto; padding:8px;" onchange="processDashboard()">
                        <div class="date-display" id="date-display">...</div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Faturamento</span><i class="fas fa-dollar-sign"></i></div>
                        <div class="card-val" id="kpi-revenue">Calculando...</div>
                        <span class="card-trend trend-up"><i class="fas fa-arrow-up"></i> Selecionado</span>
                    </div>
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Agendamentos</span><i class="fas fa-calendar-check"></i></div>
                        <div class="card-val" id="kpi-count">0</div>
                        <span class="card-trend">Volume</span>
                    </div>
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>A Receber</span><i class="fas fa-clock"></i></div>
                        <div class="card-val" id="kpi-pending" style="color:#f1c40f">Calculando...</div>
                        <span class="card-trend">Pendente</span>
                    </div>
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Ticket Médio</span><i class="fas fa-chart-line"></i></div>
                        <div class="card-val" id="kpi-ticket">Calculando...</div>
                        <span class="card-trend trend-up">Por Cliente</span>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-container">
                        <div class="chart-title">Receita (7 dias)</div>
                        <div class="canvas-wrapper"><canvas id="mainChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Serviços Mais Pedidos</div>
                        <div class="canvas-wrapper"><canvas id="donutChart"></canvas></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 50px;">
                    <div class="chart-title">Agendamentos do Dia Selecionado</div>
                    <table>
                        <thead><tr><th>Cliente</th><th>Serviço</th><th>Barbeiro</th><th>Data/Hora</th><th>Valor</th><th>Status</th></tr></thead>
                        <tbody id="live-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-agenda" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Agenda Completa</h2><p>Gerencie horários.</p></div>
                    <input type="date" id="agenda-date-picker" class="input-field" style="width: auto; cursor:pointer;" onchange="renderAgendaTable()">
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Horário</th><th>Cliente</th><th>Serviço</th><th>Barbeiro</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody id="agenda-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-leads" class="view-section">
                <div class="header">
                    <div class="page-title">
                        <h2 style="color:#e74c3c">Recuperar Clientes</h2>
                        <p>Pessoas que entraram no App mas não finalizaram.</p>
                    </div>
                    <button class="btn-action" style="color:var(--text-muted); border:1px solid #333;" onclick="renderLeadsTable()"><i class="fas fa-sync"></i> Atualizar</button>
                </div>
                <div class="card">
                    <table id="leads-table">
                        <thead><tr><th>Nome</th><th>WhatsApp</th><th>Acessou em</th><th>Situação</th><th>Ação</th></tr></thead>
                        <tbody id="leads-table-body">
                            <tr><td colspan="5" style="text-align:center; padding:20px;">Carregando acessos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-disputa" class="view-section">
                <div class="header">
                    <div class="page-title">
                        <h2>Disputa de Profissionais</h2>
                        <p>Quem está liderando o ranking?</p>
                    </div>
                </div>
                <div class="kpi-grid" style="grid-template-columns: 1fr;">
                    <div class="card champion-card">
                        <i class="fas fa-crown champion-icon"></i>
                        <div style="font-size: 0.9rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Campeão em Faturamento</div>
                        <div class="card-val" id="disp-champ-name" style="margin-top:5px; color:#fff">...</div>
                        <div id="disp-champ-val" style="color:var(--gold); font-weight:600; font-size:1.2rem;">R$ 0,00</div>
                    </div>
                </div>
                <div class="card">
                    <div class="chart-title">Ranking Geral</div>
                    <table>
                        <thead><tr><th>Posição</th><th>Barbeiro</th><th>Agendamentos</th><th>Cortes Realizados</th><th>Faturamento (Real)</th></tr></thead>
                        <tbody id="disputa-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-clientes" class="view-section">
                <div class="header"><div class="page-title"><h2>Base de Clientes</h2><p>Histórico.</p></div></div>
                <div class="card">
                    <table>
                        <thead><tr><th>Nome</th><th>WhatsApp</th><th>Visitas</th><th>Última Data</th><th>Ação</th></tr></thead>
                        <tbody id="clientes-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-financeiro" class="view-section">
                <div class="header"><div class="page-title"><h2>Financeiro</h2><p>Fluxo de Caixa.</p></div></div>
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Confirmado</span><i class="fas fa-check-circle"></i></div>
                        <div class="card-val" id="fin-confirmed" style="color:var(--success)">R$ 0,00</div>
                    </div>
                    <div class="card" style="margin-bottom:0">
                        <div class="card-head"><span>Pendente</span><i class="fas fa-hourglass-half"></i></div>
                        <div class="card-val" id="fin-potential" style="color:var(--gold)">R$ 0,00</div>
                    </div>
                </div>
                <div class="card">
                    <div class="chart-title">Extrato</div>
                    <table>
                        <thead><tr><th>Data</th><th>Cliente</th><th>Serviço</th><th>Barbeiro</th><th>Valor</th></tr></thead>
                        <tbody id="fin-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-config" class="view-section">
                <div class="header">
                    <div class="page-title"><h2>Configurações</h2><p>App do Cliente.</p></div>
                </div>
                <div class="card" style="max-width: 800px;">
                    <div class="form-grid">
                        <div class="input-group"><label>Nome da Barbearia</label><input type="text" id="cfg-nome" class="input-field"></div>
                        <div class="input-group"><label>Endereço</label><input type="text" id="cfg-endereco" class="input-field"></div>
                        <div class="input-group"><label>WhatsApp</label><input type="text" id="cfg-zap" class="input-field"></div>
                        <div class="input-group"><label>Instagram</label><input type="text" id="cfg-insta" class="input-field"></div>
                        <div class="input-group"><label>Abertura</label><input type="time" id="cfg-open" class="input-field"></div>
                        <div class="input-group"><label>Fechamento</label><input type="time" id="cfg-close" class="input-field"></div>
                        <div class="input-group"><label>Senha de Admin (Dashboard)</label><input type="text" id="cfg-senha" class="input-field" placeholder="Padrão: 1234"></div>
                    </div>
                    <button class="btn-save" onclick="saveConfig()">SALVAR</button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc, getDoc, setDoc, getDocs, where, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdidGqRySr382mykhZd3G7TqVRwJycsX4",
            authDomain: "app-barbearia-de86f.firebaseapp.com",
            projectId: "app-barbearia-de86f",
            storageBucket: "app-barbearia-de86f.firebasestorage.app",
            messagingSenderId: "67148084464",
            appId: "1:67148084464:web:90a07392ef7330294a3e35",
            measurementId: "G-LE74FLQHHN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let rawData = [];
        let leadsData = [];
        let barbersList = []; // Lista de barbeiros do banco
        let chartMain = null;
        let chartDonut = null;
        window.currentView = 'dashboard';
        let loggedIn = false;
        
        // CUSTOM CONFIRM VARS
        let confirmResolver = null;

        function getPrice(str) {
            if (!str) return 0;
            let match = str.match(/(?:R\$|PTS)\s*([\d.,]+)/i);
            if (!match) match = str.match(/(\d{2,}[.,]?\d{0,2})$/);
            if (match) {
                let valStr = match[1];
                if(valStr.includes(',') && valStr.includes('.')) valStr = valStr.replace('.', '').replace(',', '.'); 
                else if(valStr.includes(',')) valStr = valStr.replace(',', '.');
                const num = parseFloat(valStr);
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        window.onload = () => {
            document.getElementById('date-display').innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const today = new Date();
            document.getElementById('agenda-date-picker').valueAsDate = today;
            document.getElementById('dashboard-date-picker').valueAsDate = today;
            document.getElementById('loading').style.display = 'none'; // Esconde loading inicial, mostra login
        };
        
        // --- CUSTOM CONFIRM LOGIC ---
        window.showConfirm = (msg) => {
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-modal').style.display = 'flex';
            return new Promise((resolve) => {
                confirmResolver = resolve;
            });
        }
        
        window.resolveConfirm = (result) => {
            document.getElementById('confirm-modal').style.display = 'none';
            if (confirmResolver) confirmResolver(result);
        }

        // --- SISTEMA DE LOGIN ---
        window.attemptLogin = async () => {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const errorMsg = document.getElementById('login-error');

            if(!user || !pass) { errorMsg.innerText = "Preencha todos os campos."; errorMsg.style.display = 'block'; return; }

            document.getElementById('loading').style.display = 'flex';

            try {
                // 1. Config da Loja
                const configRef = doc(db, "config", "loja");
                const configSnap = await getDoc(configRef);
                
                if(!configSnap.exists()) {
                    throw new Error("Erro de configuração (Loja não encontrada).");
                }

                const lojaData = configSnap.data();
                const dbName = lojaData.nomeBarbearia || "";

                // Verifica Nome (Case insensitive e remove espaços)
                if(dbName.toLowerCase().trim() !== user.toLowerCase()) {
                    throw new Error("Nome da barbearia incorreto.");
                }

                // 2. Verifica Senha
                // Usa a senha salva em 'config/loja' OU usa o padrão '1234' se não existir
                let authorized = false;
                const senhaAdmin = lojaData.senha || "1234";

                if (String(senhaAdmin) === pass) {
                    authorized = true;
                } else {
                    // Fallback (opcional): Verifica se é barbeiro admin
                    let qBarber = query(collection(db, "barbeiros"), where("senha", "==", pass));
                    let barberSnaps = await getDocs(qBarber);
                    if (!barberSnaps.empty) authorized = true;
                    
                    if (!authorized && !isNaN(pass)) {
                        qBarber = query(collection(db, "barbeiros"), where("senha", "==", Number(pass)));
                        barberSnaps = await getDocs(qBarber);
                        if (!barberSnaps.empty) authorized = true;
                    }
                }

                if(!authorized) {
                    throw new Error("Senha incorreta.");
                }

                // SUCESSO
                loggedIn = true;
                document.getElementById('brand-name').innerText = lojaData.nomeBarbearia; // Atualiza nome no menu
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-interface').style.display = 'flex';
                initListeners();

            } catch(e) {
                errorMsg.innerText = e.message || "Erro ao entrar.";
                errorMsg.style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        };

        function initListeners() {
            // --- LISTENER AGENDAMENTOS ---
            const q = query(collection(db, "agendamentos"), orderBy("id", "desc"));
            onSnapshot(q, (snapshot) => {
                rawData = snapshot.docs.map(d => ({ firebaseId: d.id, ...d.data() }));
                processDashboard();
                if(window.currentView === 'agenda') renderAgendaTable();
                if(window.currentView === 'clientes') renderClientsTable();
                if(window.currentView === 'financeiro') renderFinanceTable();
                if(window.currentView === 'leads') renderLeadsTable();
                if(window.currentView === 'disputa') renderDisputa();
                document.getElementById('loading').style.display = 'none';
            });

            // --- LISTENER LEADS (ACESSO) ---
            const qLeads = query(collection(db, "acessos"), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(qLeads, (snapshot) => {
                leadsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                if(window.currentView === 'leads') renderLeadsTable();
            });

            // --- LISTENER BARBEIROS (NOVO) ---
            const qBarbers = query(collection(db, "barbeiros"));
            onSnapshot(qBarbers, (snapshot) => {
                barbersList = snapshot.docs.map(d => d.data());
                if(window.currentView === 'disputa') renderDisputa();
            });
            
            loadConfig();
        }

        window.switchView = (viewId, el) => {
            if(!loggedIn) return;
            window.currentView = viewId;
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            
            if(viewId === 'agenda') renderAgendaTable();
            if(viewId === 'clientes') renderClientsTable();
            if(viewId === 'financeiro') renderFinanceTable();
            if(viewId === 'leads') renderLeadsTable();
            if(viewId === 'disputa') renderDisputa();
            if(viewId === 'config') loadConfig();
        }

        // --- LÓGICA DE DISPUTA ATUALIZADA ---
        window.renderDisputa = () => {
            const tbody = document.getElementById('disputa-table-body');
            tbody.innerHTML = '';
            
            const stats = {};

            // 1. Inicializa estatísticas para TODOS os barbeiros do banco (mesmo sem cortes)
            barbersList.forEach(b => {
                const nome = b.nome || 'Profissional';
                stats[nome] = { nome: nome, totalAgendamentos: 0, cortesFeitos: 0, revenue: 0 };
            });
            
            // 2. Processa os agendamentos para somar
            rawData.forEach(item => {
                const barb = item.barbeiro || 'Desconhecido';
                
                // Se o barbeiro do agendamento não estava na lista (ex: apagado), cria entrada
                if(!stats[barb]) stats[barb] = { nome: barb, totalAgendamentos: 0, cortesFeitos: 0, revenue: 0 };
                
                // Contabiliza TODOS os agendamentos (volume total)
                stats[barb].totalAgendamentos++;

                // Contabiliza apenas CONCLUÍDOS para Faturamento e Cortes Feitos
                if(item.status === 'concluido') {
                    const price = getPrice(item.servico);
                    stats[barb].cortesFeitos++;
                    stats[barb].revenue += price;
                }
            });

            // Converte para array e ordena por Faturamento (Revenue)
            const rank = Object.values(stats).sort((a,b) => b.revenue - a.revenue);

            // Atualiza Campeão
            if(rank.length > 0) {
                document.getElementById('disp-champ-name').innerText = rank[0].nome;
                document.getElementById('disp-champ-val').innerText = `R$ ${rank[0].revenue.toFixed(2)}`;
            } else {
                document.getElementById('disp-champ-name').innerText = "-";
                document.getElementById('disp-champ-val').innerText = "R$ 0,00";
            }

            // Renderiza Tabela
            rank.forEach((r, index) => {
                const pos = index + 1;
                let badgeClass = 'rank-other';
                if(pos === 1) badgeClass = 'rank-1';
                else if(pos === 2) badgeClass = 'rank-2';
                else if(pos === 3) badgeClass = 'rank-3';

                tbody.innerHTML += `
                    <tr>
                        <td><span class="rank-badge ${badgeClass}">#${pos}</span></td>
                        <td style="color:#fff; font-weight:600">${r.nome}</td>
                        <td>${r.totalAgendamentos}</td>
                        <td>${r.cortesFeitos}</td>
                        <td style="color:var(--gold)">R$ ${r.revenue.toFixed(2)}</td>
                    </tr>
                `;
            });
        }

        // --- LÓGICA DE RECUPERAÇÃO DE LEADS ---
        window.renderLeadsTable = () => {
            const tbody = document.getElementById('leads-table-body');
            tbody.innerHTML = '';
            const agendadosZaps = new Set(rawData.map(a => a.zapUsuario));

            if(leadsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum acesso registrado ainda.</td></tr>';
                return;
            }

            leadsData.forEach(lead => {
                const converteu = agendadosZaps.has(lead.zap);
                let statusHtml = '', actionHtml = '';

                if(converteu) {
                    statusHtml = '<span class="status-pill st-recovered">Agendou</span>';
                    actionHtml = `
                        <span style="color:#666; font-size:0.8rem; margin-right:10px;">Resolvido</span>
                        <button onclick="deleteLead('${lead.id}')" class="btn-action btn-trash" title="Apagar da lista"><i class="fas fa-trash"></i></button>
                    `;
                } else {
                    statusHtml = '<span class="status-pill st-lost">Sem Agendamento</span>';
                    const msg = `Olá ${lead.nome}, vi que você acessou nosso app mas não finalizou o agendamento. Posso ajudar?`;
                    const link = `https://wa.me/${lead.zap}?text=${encodeURIComponent(msg)}`;
                    actionHtml = `
                        <a href="${link}" target="_blank" class="btn-action btn-recover btn-whatsapp"><i class="fab fa-whatsapp"></i> Chamar</a>
                        <button onclick="deleteLead('${lead.id}')" class="btn-action btn-trash" title="Apagar da lista"><i class="fas fa-trash"></i></button>
                    `;
                }

                tbody.innerHTML += `<tr><td>${lead.nome}</td><td>${lead.zap}</td><td>${lead.data} às ${lead.hora}</td><td>${statusHtml}</td><td>${actionHtml}</td></tr>`;
            });
        };

        window.deleteLead = async (id) => {
            if(await showConfirm("Deseja apagar este registro de acesso?")) {
                try {
                    await deleteDoc(doc(db, "acessos", id));
                    showToast("Registro apagado!");
                } catch(e) { alert("Erro ao apagar"); }
            }
        }

        window.deleteClient = async (zap) => {
            if(!zap || zap === 'undefined') return alert("Erro: Cliente sem WhatsApp vinculado.");
            if(await showConfirm("ATENÇÃO: Isso apagará TODO o histórico de agendamentos deste cliente. Continuar?")) {
                const toDelete = rawData.filter(i => i.zapUsuario === zap);
                for(const item of toDelete) {
                    await deleteDoc(doc(db, "agendamentos", item.firebaseId));
                }
                showToast("Histórico do cliente apagado!");
            }
        }

        // --- DASHBOARD ---
        window.processDashboard = () => {
            // Pega data selecionada no Dashboard
            const dateInput = document.getElementById('dashboard-date-picker');
            let selectedDateStr = "";
            if(dateInput.value) {
                const [y, m, d] = dateInput.value.split('-');
                selectedDateStr = `${d}/${m}/${y}`;
            }

            let totalRev = 0, totalPending = 0;
            // Arrays para o Gráfico (ainda mostra últimos 7 dias para contexto)
            const daysMap = {};
            const pieMap = {};
            for(let i=6; i>=0; i--) { 
                const d = new Date(); d.setDate(d.getDate() - i); 
                daysMap[d.toLocaleDateString('pt-BR')] = 0; 
            }

            // Dados filtrados apenas para a data selecionada (para os KPIs)
            let selectedDateCount = 0;
            let selectedDateRevenue = 0;
            let selectedDatePending = 0;
            let selectedDateItems = [];

            rawData.forEach(item => {
                const price = getPrice(item.servico);
                
                // Popula gráfico (geral)
                if(daysMap.hasOwnProperty(item.data)) daysMap[item.data] += price;
                const sName = item.servico.split('(')[0].split('R$')[0].trim();
                pieMap[sName] = (pieMap[sName] || 0) + 1;

                // Lógica da data selecionada
                if(item.data === selectedDateStr) {
                    selectedDateCount++;
                    selectedDateRevenue += price;
                    if(item.status !== 'concluido') selectedDatePending += price;
                    selectedDateItems.push(item);
                }
            });

            // Atualiza KPIs com base na DATA SELECIONADA
            document.getElementById('kpi-revenue').innerText = `R$ ${selectedDateRevenue.toFixed(2)}`;
            document.getElementById('kpi-count').innerText = selectedDateCount;
            document.getElementById('kpi-pending').innerText = `R$ ${selectedDatePending.toFixed(2)}`;
            const ticket = selectedDateCount ? selectedDateRevenue / selectedDateCount : 0;
            document.getElementById('kpi-ticket').innerText = `R$ ${ticket.toFixed(2)}`;

            // Atualiza Tabela "Ao Vivo" apenas com a data selecionada
            const tbody = document.getElementById('live-table-body');
            tbody.innerHTML = '';
            if(selectedDateItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:15px;">Nenhum agendamento para esta data.</td></tr>';
            } else {
                selectedDateItems.sort((a,b) => a.hora.localeCompare(b.hora)).forEach(item => {
                    const price = getPrice(item.servico);
                    const st = item.status === 'concluido' ? 'st-concluido' : 'st-pendente';
                    tbody.innerHTML += `<tr><td>${item.cliente}</td><td>${item.servico.split('(')[0].split('R$')[0]}</td><td>${item.barbeiro}</td><td>${item.data} <small>${item.hora}</small></td><td style="color:var(--gold)">R$ ${price}</td><td><span class="status-pill ${st}">${item.status}</span></td></tr>`;
                });
            }

            renderCharts(daysMap, pieMap);
        }

        function renderCharts(lineData, pieData) {
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            if(chartMain) chartMain.destroy();
            let gradient = ctx1.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(212, 175, 55, 0.4)'); gradient.addColorStop(1, 'rgba(212, 175, 55, 0.0)');
            chartMain = new Chart(ctx1, {
                type: 'line',
                data: { labels: Object.keys(lineData).map(d=>d.substring(0,5)), datasets: [{ label: 'Receita', data: Object.values(lineData), borderColor: '#d4af37', backgroundColor: gradient, fill: true, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#222' } }, x: { grid: { display: false } } } }
            });

            const ctx2 = document.getElementById('donutChart').getContext('2d');
            if(chartDonut) chartDonut.destroy();
            chartDonut = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: Object.keys(pieData), datasets: [{ data: Object.values(pieData), backgroundColor: ['#d4af37', '#f1c40f', '#e67e22', '#3498db'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#888', boxWidth: 10 } } }, cutout: '70%' }
            });
        }

        window.renderAgendaTable = () => {
            const picker = document.getElementById('agenda-date-picker');
            if(!picker.value) return;
            const [y, m, d] = picker.value.split('-');
            const dateStr = `${d}/${m}/${y}`;
            const tbody = document.getElementById('agenda-table-body');
            tbody.innerHTML = '';
            const filtered = rawData.filter(i => i.data === dateStr).sort((a,b)=>a.hora.localeCompare(b.hora));
            if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px;">Vazio.</td></tr>'; return; }
            filtered.forEach(item => {
                const price = getPrice(item.servico);
                const isDone = item.status === 'concluido';
                const st = isDone ? 'st-concluido' : 'st-pendente';
                
                // Botão de notificação (Sino) apenas se não concluído
                const notifyBtn = !isDone ? `<button class="btn-action btn-notify" onclick="sendPushReminder('${item.firebaseId}', '${item.cliente}')" title="Enviar Lembrete Push"><i class="fas fa-bell"></i></button>` : '';
                
                const checkBtn = !isDone ? `<button class="btn-action btn-check" onclick="updateStatus('${item.firebaseId}', 'concluido')"><i class="fas fa-check"></i></button>` : '';
                const trashBtn = `<button class="btn-action btn-trash" onclick="deleteAppt('${item.firebaseId}')"><i class="fas fa-trash"></i></button>`;

                tbody.innerHTML += `<tr><td style="color:#fff; font-weight:600">${item.hora}</td><td>${item.cliente}</td><td>${item.servico.split('(')[0].split('R$')[0]}</td><td>${item.barbeiro}</td><td style="color:var(--gold)">R$ ${price}</td><td><span class="status-pill ${st}">${item.status}</span></td><td>${checkBtn}${notifyBtn}${trashBtn}</td></tr>`;
            });
        }
        
        window.sendPushReminder = async (id, name) => {
            const item = rawData.find(i => i.firebaseId === id);
            if(!item) return;

            if(await showConfirm(`Enviar notificação push de lembrete para ${name}?`)) {
                try {
                    // 1. Atualiza o agendamento para marcar que o lembrete foi solicitado
                    await updateDoc(doc(db, "agendamentos", id), { 
                        lembreteEnviado: new Date().toISOString(),
                        statusNotificacao: 'pendente'
                    });

                    // 2. Cria o registro na coleção de notificações (Padrão para sistemas PWA/Firebase)
                    // Tenta usar o zapUsuario como ID do usuário ou tópico
                    if(item.zapUsuario) {
                        await addDoc(collection(db, "notificacoes"), {
                            destinatario: item.zapUsuario,
                            titulo: "Lembrete de Agendamento",
                            mensagem: `Olá ${name}, não esqueça seu corte hoje às ${item.hora} com ${item.barbeiro}.`,
                            lida: false,
                            data: new Date().toISOString(),
                            tipo: 'lembrete',
                            agendamentoId: id
                        });
                    }

                    showToast("Notificação enviada!");
                } catch(e) {
                    alert("Erro ao enviar: " + e.message);
                }
            }
        }

        window.renderClientsTable = () => {
            const tbody = document.getElementById('clientes-table-body');
            tbody.innerHTML = '';
            const map = {};
            rawData.forEach(item => {
                const key = item.cliente + (item.zapUsuario || '');
                if(!map[key]) map[key] = { nome: item.cliente, zap: item.zapUsuario, count: 0, last: '' };
                map[key].count++; map[key].last = item.data; 
            });
            Object.values(map).forEach(c => {
                const btn = c.zap ? `<a href="https://wa.me/${c.zap}" target="_blank" class="btn-action btn-whatsapp">Conversar</a>` : '-';
                // ADICIONADO BOTÃO DE DELETE
                tbody.innerHTML += `<tr>
                    <td style="color:#fff">${c.nome}</td>
                    <td>${c.zap||'-'}</td>
                    <td>${c.count}</td>
                    <td>${c.last}</td>
                    <td>
                        ${btn}
                        <button onclick="deleteClient('${c.zap}')" class="btn-action btn-trash" title="Apagar Histórico"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        window.renderFinanceTable = () => {
            const tbody = document.getElementById('fin-table-body');
            tbody.innerHTML = '';
            let conf = 0, pend = 0;
            [...rawData].sort((a,b)=>b.id-a.id).forEach(item => {
                const price = getPrice(item.servico);
                if(item.status === 'concluido') { conf += price; tbody.innerHTML += `<tr><td>${item.data}</td><td>${item.cliente}</td><td>${item.servico.split('(')[0]}</td><td>${item.barbeiro}</td><td style="color:var(--gold)">R$ ${price}</td></tr>`; }
                else { pend += price; }
            });
            document.getElementById('fin-confirmed').innerText = `R$ ${conf.toFixed(2)}`;
            document.getElementById('fin-potential').innerText = `R$ ${pend.toFixed(2)}`;
        }

        window.loadConfig = async () => {
            const snap = await getDoc(doc(db, "config", "loja"));
            if (snap.exists()) {
                const d = snap.data();
                if(loggedIn) document.getElementById('brand-name').innerText = d.nomeBarbearia || 'BarberLabel'; // Atualiza também aqui
                ['nome','endereco','zap','insta','open','close'].forEach(k => document.getElementById('cfg-'+k).value = d[k === 'nome' ? 'nomeBarbearia' : k === 'zap' ? 'whatsapp' : k === 'insta' ? 'instagram' : k === 'open' ? 'openTime' : k === 'close' ? 'closeTime' : k] || '');
                // NEW: Load password
                document.getElementById('cfg-senha').value = d.senha || '';
            }
        }

        window.saveConfig = async () => {
            const d = { 
                nomeBarbearia: document.getElementById('cfg-nome').value, 
                endereco: document.getElementById('cfg-endereco').value, 
                whatsapp: document.getElementById('cfg-zap').value, 
                instagram: document.getElementById('cfg-insta').value, 
                openTime: document.getElementById('cfg-open').value, 
                closeTime: document.getElementById('cfg-close').value,
                senha: document.getElementById('cfg-senha').value || "1234" // Default save if empty
            };
            try { await setDoc(doc(db, "config", "loja"), d, { merge: true }); showToast("Salvo!"); document.getElementById('brand-name').innerText = d.nomeBarbearia; } catch(e) { alert(e); }
        }

        window.updateStatus = async (id, s) => { if(await showConfirm("Deseja confirmar o atendimento?")) { await updateDoc(doc(db, "agendamentos", id), { status: s }); showToast("Atualizado!"); } }
        window.deleteAppt = async (id) => { if(await showConfirm("Deseja apagar este agendamento?")) { await deleteDoc(doc(db, "agendamentos", id)); showToast("Apagado!"); } }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
    </script>
</body>
</html>
