<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Master - BarberLabel</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --accent-color: #d4af37; 
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2a2a2a;
            --text-main: #f5f5f5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative;
        }

        header { text-align: center; margin-bottom: 30px; }
        h1 { font-family: 'Playfair Display', serif; color: var(--accent-color); font-size: 2rem; }
        
        .form-section { margin-bottom: 25px; padding: 20px; border: 1px solid #333; border-radius: 12px; background: #181818; }
        .section-title { color: #fff; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }

        label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        input, select, textarea {
            width: 100%; background: var(--input-bg); border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 6px; outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--accent-color); }

        /* AREA DA IA */
        .ai-bar {
            background: linear-gradient(135deg, #1e1e1e, #0e2a47);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #4285f4;
            position: relative;
            overflow: hidden;
        }
        .ai-btn {
            background: #4285f4; color: #fff; font-weight: bold; border: none;
            padding: 12px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;
            margin-top: 15px; width: 100%; justify-content: center; transition: 0.2s;
        }
        .ai-btn:hover { background: #3367d6; transform: scale(1.02); }

        /* UPLOAD */
        .file-upload-wrapper {
            position: relative; background: var(--input-bg); border: 1px dashed #555;
            border-radius: 8px; padding: 15px; text-align: center;
        }
        .current-img-preview {
            width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 2px solid var(--accent-color);
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none;
        }

        /* PROFISSIONAIS */
        .prof-item { display: flex; gap: 10px; align-items: center; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .btn-remove { background: #ff4d4d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-add { background: transparent; border: 1px dashed var(--accent-color); color: var(--accent-color); width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; }

        /* DIAS */
        .days-grid { display: flex; gap: 5px; flex-wrap: wrap; }
        .day-check { display: none; }
        .day-label { flex: 1; text-align: center; padding: 8px; background: #222; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: #777; }
        .day-check:checked + .day-label { background: var(--accent-color); color: #000; font-weight: bold; }

        .btn-save { width: 100%; padding: 15px; background: var(--accent-color); color: #000; font-weight: bold; font-size: 1rem; border: none; border-radius: 10px; cursor: pointer; margin-top: 20px; }
        .btn-save:disabled { background: #444; cursor: wait; }

        /* BOTÃO RESET */
        .btn-reset {
            width: 100%; padding: 12px; background: transparent; color: #ff4d4d;
            font-weight: 600; font-size: 0.9rem; border: 1px solid #ff4d4d; border-radius: 10px;
            cursor: pointer; margin-top: 15px; transition: 0.2s;
        }
        .btn-reset:hover { background: rgba(255, 77, 77, 0.1); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Painel Master</h1>
            <p style="color:#666; font-size:0.8rem;">Automação via Google Gemini</p>
        </header>

        <div class="ai-bar">
            <h3 style="color:white; margin-bottom:10px;">
                <i class="fas fa-sparkles" style="color:#fbbc04"></i> Preenchimento Automático
            </h3>
            <p style="color:#ccc; font-size:0.8rem; margin-bottom:10px;">
                Copie a <strong>BIO completa</strong> do Instagram e cole abaixo. A IA vai preencher tudo e gerar o link do Maps.
            </p>
            
            <textarea id="aiInputText" rows="4" placeholder="Ex: Barbearia do João. Rua X, número 10. Tel: (11) 99999-9999..." style="color:white; font-size:0.9rem;"></textarea>
            
            <button class="ai-btn" onclick="preencherComGemini()">
                <i class="fas fa-bolt"></i> Processar com IA
            </button>
        </div>

        <form id="masterForm">
            <div class="form-section">
                <div class="section-title"><i class="fas fa-image"></i> Identidade Visual</div>
                <div class="input-group" style="margin-bottom:15px;">
                    <label>Nome da Barbearia</label>
                    <input type="text" id="nomeBarbearia">
                </div>
                <div class="row">
                    <div>
                        <label>Logo (Upload)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="logoFile" accept="image/*">
                            <img id="preview-logo" class="current-img-preview">
                        </div>
                    </div>
                    <div>
                        <label>Capa/Story (Upload)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="storyFile" accept="image/*">
                            <img id="preview-story" class="current-img-preview">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div><label>Cor do Tema</label><input type="color" id="themeColor" value="#d4af37" style="height:40px;"></div>
                    <div><label>Frase Login</label><input type="text" id="loginSubtitle"></div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title"><i class="fas fa-users"></i> Equipe</div>
                <div id="prof-list"></div>
                <button type="button" class="btn-add" onclick="adicionarCampoProfissional()"><i class="fas fa-plus"></i> Adicionar Barbeiro</button>
            </div>

            <div class="form-section">
                <div class="section-title"><i class="fas fa-map-marker-alt"></i> Contato</div>
                <div class="row">
                    <div><label>WhatsApp (DDD+Num)</label><input type="text" id="whatsapp"></div>
                    <div><label>Instagram (Link)</label><input type="text" id="instagram"></div>
                </div>
                <div style="margin-bottom:10px;">
                    <label>Endereço</label>
                    <input type="text" id="endereco" onchange="gerarLinkMapsManual()">
                </div>
                <div>
                    <label>Link Maps (Gerado Automaticamente)</label>
                    <input type="text" id="mapsLink">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title"><i class="fas fa-clock"></i> Horários</div>
                <div class="row">
                    <div><label>Abre</label><input type="time" id="openTime"></div>
                    <div><label>Fecha</label><input type="time" id="closeTime"></div>
                </div>
                <div class="days-grid">
                    <input type="checkbox" id="dom" value="0" class="day-check"><label for="dom" class="day-label">Dom</label>
                    <input type="checkbox" id="seg" value="1" class="day-check"><label for="seg" class="day-label">Seg</label>
                    <input type="checkbox" id="ter" value="2" class="day-check"><label for="ter" class="day-label">Ter</label>
                    <input type="checkbox" id="qua" value="3" class="day-check"><label for="qua" class="day-label">Qua</label>
                    <input type="checkbox" id="qui" value="4" class="day-check"><label for="qui" class="day-label">Qui</label>
                    <input type="checkbox" id="sex" value="5" class="day-check"><label for="sex" class="day-label">Sex</label>
                    <input type="checkbox" id="sab" value="6" class="day-check"><label for="sab" class="day-label">Sáb</label>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title"><i class="fas fa-lock"></i> Senha Painel</div>
                <input type="text" id="adminPass" placeholder="1234">
            </div>

            <button type="submit" id="btn-submit" class="btn-save">SALVAR TUDO</button>
            
            <button type="button" onclick="restaurarPadrao()" class="btn-reset">
                <i class="fas fa-undo"></i> Restaurar Padrão
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURAÇÕES ---
        const IMG_BB_KEY = "fde585c6f206d65b90271edd2d43b65e";
        const GEMINI_API_KEY = "AIzaSyBN1Ho5Xv73MbFsUirb0MibxSzu716HBUM"; 

        const firebaseConfig = {
            apiKey: "AIzaSyCdidGqRySr382mykhZd3G7TqVRwJycsX4",
            authDomain: "app-barbearia-de86f.firebaseapp.com",
            projectId: "app-barbearia-de86f",
            storageBucket: "app-barbearia-de86f.firebasestorage.app",
            messagingSenderId: "67148084464",
            appId: "1:67148084464:web:90a07392ef7330294a3e35",
            measurementId: "G-LE74FLQHHN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentConfig = {};

        // --- FUNÇÃO AUXILIAR: GERAR LINK MAPS ---
        window.gerarLinkMapsManual = function() {
            const end = document.getElementById('endereco').value;
            if(end) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(end)}`;
                document.getElementById('mapsLink').value = url;
            }
        }

        // --- RESTAURAR PADRÃO ---
        window.restaurarPadrao = async function() {
            if(!confirm("⚠️ Tem certeza? Isso apagará todas as configurações.")) return;
            const defaultConfig = {
                nomeBarbearia: "Barbearia",
                themeColor: "#d4af37",
                loginSubtitle: "Agende seu estilo em segundos",
                whatsapp: "",
                instagram: "",
                endereco: "",
                mapsLink: "",
                openTime: "08:00",
                closeTime: "20:00",
                adminPass: "1234",
                logoUrl: "https://placehold.co/150/d4af37/000?text=LOGO",
                storyUrl: "https://placehold.co/400x800/222/d4af37?text=Story",
                openDays: [1, 2, 3, 4, 5, 6],
                profissionais: [
                    { id: Date.now(), nome: "Profissional 1", foto: "https://placehold.co/150/333/FFF?text=P1" },
                    { id: Date.now()+1, nome: "Profissional 2", foto: "https://placehold.co/150/333/FFF?text=P2" }
                ]
            };
            try {
                await setDoc(doc(db, "config", "loja"), defaultConfig);
                alert("✅ Restaurado!");
                location.reload();
            } catch(e) { alert("Erro: " + e.message); }
        }

        // --- LÓGICA GEMINI ---
        window.preencherComGemini = async function() {
            const text = document.getElementById('aiInputText').value;
            const btn = document.querySelector('.ai-btn');

            if(!text) return alert("Cole o texto da bio no campo indicado.");

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            
            const prompt = `
                Analise este texto de bio de Instagram de barbearia: "${text}"
                Extraia JSON válido:
                {
                    "nomeBarbearia": "Nome do local",
                    "whatsapp": "numeros com DDD (55...)",
                    "endereco": "endereço completo",
                    "loginSubtitle": "frase de efeito",
                    "instagram": "link do perfil",
                    "openTime": "horario abertura HH:MM (ex: 09:00)",
                    "closeTime": "horario fechamento HH:MM (ex: 19:00)",
                    "openDays": [array numeros 0=Dom a 6=Sab]
                }
            `;

            try {
                // TENTATIVA 1: GEMINI 3 FLASH
                let url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash:generateContent?key=${GEMINI_API_KEY}`;
                let response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                let data = await response.json();
                
                // TENTATIVA 2: FALLBACK
                if(data.error) {
                    console.warn("Fallback...", data.error);
                    url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                    response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    data = await response.json();
                }

                if(data.error) throw new Error(data.error.message);
                
                let content = data.candidates[0].content.parts[0].text;
                const startIndex = content.indexOf('{');
                const endIndex = content.lastIndexOf('}');
                if (startIndex !== -1) content = content.substring(startIndex, endIndex + 1);
                
                const result = JSON.parse(content);

                // Preencher campos
                if(result.nomeBarbearia) document.getElementById('nomeBarbearia').value = result.nomeBarbearia;
                if(result.whatsapp) document.getElementById('whatsapp').value = result.whatsapp;
                if(result.endereco) {
                    document.getElementById('endereco').value = result.endereco;
                    // GERAR LINK MAPS AUTOMATICO
                    const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(result.endereco)}`;
                    document.getElementById('mapsLink').value = mapsLink;
                }
                if(result.loginSubtitle) document.getElementById('loginSubtitle').value = result.loginSubtitle;
                if(result.instagram) document.getElementById('instagram').value = result.instagram;
                if(result.openTime) document.getElementById('openTime').value = result.openTime;
                if(result.closeTime) document.getElementById('closeTime').value = result.closeTime;
                
                if(result.openDays && Array.isArray(result.openDays)) {
                    document.querySelectorAll('.day-check').forEach(chk => chk.checked = false);
                    result.openDays.forEach(day => {
                        const el = document.querySelector(`.day-check[value="${day}"]`);
                        if(el) el.checked = true;
                    });
                }
                
                alert("✨ Dados preenchidos e Link do Maps gerado!");

            } catch (error) {
                console.error("Erro:", error);
                alert("Falha: " + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-bolt"></i> Processar com IA';
            }
        }

        // --- UPLOAD IMGBB ---
        async function uploadToImgBB(file) {
            if (!file) return null;
            const formData = new FormData();
            formData.append("image", file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_KEY}`, { method: "POST", body: formData });
                const data = await res.json();
                return data.success ? data.data.url : null;
            } catch (e) { return null; }
        }

        // --- FUNÇÕES GERAIS ---
        window.adicionarCampoProfissional = (nome = "", fotoUrl = "") => {
            const container = document.getElementById('prof-list');
            const div = document.createElement('div');
            div.className = 'prof-item';
            div.innerHTML = `
                <div style="flex:1; display:flex; gap:10px; align-items:center;">
                    <input type="text" class="prof-name-input" placeholder="Nome" value="${nome}">
                    <div style="flex:1;">
                        <input type="file" class="prof-file-input" accept="image/*">
                        <input type="hidden" class="prof-url-hidden" value="${fotoUrl}">
                        ${fotoUrl ? `<small style="color:var(--accent-color)">Foto salva</small>` : ''}
                    </div>
                </div>
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
        }

        async function loadData() {
            try {
                const docSnap = await getDoc(doc(db, "config", "loja"));
                if (docSnap.exists()) {
                    currentConfig = docSnap.data();
                    const f = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val || ""; }
                    
                    f('nomeBarbearia', currentConfig.nomeBarbearia);
                    f('themeColor', currentConfig.themeColor || "#d4af37");
                    f('loginSubtitle', currentConfig.loginSubtitle);
                    f('whatsapp', currentConfig.whatsapp);
                    f('instagram', currentConfig.instagram);
                    f('endereco', currentConfig.endereco);
                    f('mapsLink', currentConfig.mapsLink);
                    f('openTime', currentConfig.openTime);
                    f('closeTime', currentConfig.closeTime);
                    f('adminPass', currentConfig.adminPass);

                    if(currentConfig.logoUrl) { document.getElementById('preview-logo').src = currentConfig.logoUrl; document.getElementById('preview-logo').style.display = 'block'; }
                    if(currentConfig.storyUrl) { document.getElementById('preview-story').src = currentConfig.storyUrl; document.getElementById('preview-story').style.display = 'block'; }
                    
                    if(currentConfig.openDays) {
                        document.querySelectorAll('.day-check').forEach(chk => {
                            chk.checked = currentConfig.openDays.includes(parseInt(chk.value));
                        });
                    }
                    
                    document.getElementById('prof-list').innerHTML = '';
                    const profs = currentConfig.profissionais || [];
                    if(profs.length > 0) profs.forEach(p => adicionarCampoProfissional(p.nome, p.foto));
                    else adicionarCampoProfissional();
                } else adicionarCampoProfissional();
            } catch (e) { console.error(e); adicionarCampoProfissional(); }
        }

        loadData();

        document.getElementById('masterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = 'ENVIANDO...'; btn.disabled = true;

            try {
                const logoFile = document.getElementById('logoFile').files[0];
                let finalLogo = currentConfig.logoUrl || "";
                if(logoFile) { const url = await uploadToImgBB(logoFile); if(url) finalLogo = url; }

                const storyFile = document.getElementById('storyFile').files[0];
                let finalStory = currentConfig.storyUrl || "";
                if(storyFile) { const url = await uploadToImgBB(storyFile); if(url) finalStory = url; }

                const profItems = document.querySelectorAll('.prof-item');
                let finalProfs = [];
                for(const item of profItems) {
                    const nome = item.querySelector('.prof-name-input').value;
                    const fileInput = item.querySelector('.prof-file-input');
                    let fotoUrl = item.querySelector('.prof-url-hidden').value;

                    if(fileInput.files.length > 0) {
                        const newUrl = await uploadToImgBB(fileInput.files[0]);
                        if(newUrl) fotoUrl = newUrl;
                    } else if(!fotoUrl) {
                        fotoUrl = "https://placehold.co/150/333/FFF?text=" + (nome.charAt(0) || "B");
                    }
                    if(nome) finalProfs.push({ id: Date.now()+Math.random(), nome, foto: fotoUrl });
                }

                const days = [];
                document.querySelectorAll('.day-check:checked').forEach(c => days.push(parseInt(c.value)));

                const newConfig = {
                    ...currentConfig,
                    nomeBarbearia: document.getElementById('nomeBarbearia').value,
                    themeColor: document.getElementById('themeColor').value,
                    loginSubtitle: document.getElementById('loginSubtitle').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    instagram: document.getElementById('instagram').value,
                    endereco: document.getElementById('endereco').value,
                    mapsLink: document.getElementById('mapsLink').value,
                    openTime: document.getElementById('openTime').value,
                    closeTime: document.getElementById('closeTime').value,
                    adminPass: document.getElementById('adminPass').value,
                    logoUrl: finalLogo,
                    storyUrl: finalStory,
                    profissionais: finalProfs,
                    openDays: days
                };

                await setDoc(doc(db, "config", "loja"), newConfig);
                alert("✅ Salvo com Sucesso!");
                loadData();
            } catch(err) {
                console.error(err);
                alert("Erro ao salvar.");
            } finally {
                btn.innerText = 'SALVAR TUDO'; btn.disabled = false;
            }
        });
    </script>
</body>
</html>
